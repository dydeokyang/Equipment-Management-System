<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>디와이덕양 비품관리</title>
<style>
  :root{
    --bg:#fff; --fg:#16181b; --muted:#667085; --border:#e6e8eb; --shadow:0 4px 14px rgba(0,0,0,.08);
    --chip-id:#eef2ff; --chip-id-text:#1d4ed8; --chip-name:#ecfdf5; --chip-name-text:#065f46;
    --chip-loc:#fff7ed; --chip-loc-text:#9a3412; --chip-owner:#fef2f2; --chip-owner-text:#b91c1c;
    --focus:#0ea5e9; --okbg:#ecfdf5; --ok:#065f46;
  }
  body{font-family:system-ui,malgun gothic,apple sd gothic neo,arial;background:var(--bg);color:var(--fg);max-width:980px;margin:28px auto;padding:0 16px}
  h1{font-size:22px;margin:14px 0}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:12px 0}
  button{font-size:16px;padding:10px 16px;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer}
  button:hover{border-color:#c9ced6}
  label.chk{display:flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
  label.chk input{width:18px;height:18px}
  .count{margin-left:auto;color:#333;font-size:14px}
  #msg{margin:8px 2px;color:#475569}

  /* 미리보기 공용 */
  #previewHost{margin:10px 0}
  #preview{position:relative;width:100%;max-width:560px;aspect-ratio:1/1;overflow:hidden;border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);display:none;background:transparent}
  #video,#overlay{position:absolute;inset:0;width:100%;height:100%;display:none;object-fit:cover;object-position:center;pointer-events:none;background:transparent}

  .card{background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:16px;margin:16px 0}
  .subtitle{color:var(--muted);font-size:13px;margin-top:-6px;margin-bottom:10px}
  table{border-collapse:separate;border-spacing:0;width:100%}
  th,td{padding:12px;border-bottom:1px solid var(--border);text-align:left;word-break:break-all}
  tbody tr:nth-child(even){background:#fcfdff}
  tbody tr:last-child td, tbody tr:last-child th{border-bottom:0}
  th.key{font-weight:600;background:transparent;padding:6px 0}
  .chip{display:inline-block;padding:4px 10px;border-radius:999px;font-size:13px}
  .chip.id{background:var(--chip-id);color:var(--chip-id-text)}
  .chip.name{background:var(--chip-name);color:var(--chip-name-text)}
  .chip.loc{background:var(--chip-loc);color:var(--chip-loc-text)}
  .chip.owner{background:var(--chip-owner);color:var(--chip-owner-text)}

  /* 비품 촬영 패널 */
  .photo-step{display:none;margin-top:14px;border:2px dashed var(--focus);border-radius:12px;padding:12px}
  .photo-head{display:flex;align-items:center;gap:10px;margin-bottom:10px;background:var(--okbg);color:var(--ok);border:1px solid #cce7dd;padding:8px 10px;border-radius:8px;font-weight:600}
  .photo-grid{display:grid;grid-template-columns:1.15fr .85fr;gap:14px;align-items:start}
  @media (max-width:900px){ .photo-grid{grid-template-columns:1fr} }
  .photo-chips{display:flex;flex-wrap:wrap;gap:8px}
  .photo-slot{position:relative;width:100%;aspect-ratio:4/3;border-radius:10px;overflow:hidden;border:2px solid var(--focus);background:transparent}
  .photo-slot #photoLive{display:block;width:100%;height:100%}
  .hint{font-size:13px;color:#475569;margin-top:6px}
  .actions{display:flex;gap:10px;margin-top:8px;flex-wrap:wrap}

  .list{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:760px){ .list{grid-template-columns:1fr} }
  .item{border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff;box-shadow:var(--shadow)}
  .item .head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .item .time{font-size:13px;color:#334155;background:#f1f5f9;border-radius:6px;padding:4px 8px}
  .badges{display:flex;flex-wrap:wrap;gap:6px}
  .badge{font-size:12px;border-radius:999px;padding:3px 8px}
  .badge.id{background:var(--chip-id);color:var(--chip-id-text)}
  .badge.name{background:var(--chip-name);color:var(--chip-name-text)}
  .badge.loc{background:var(--chip-loc);color:var(--chip-loc-text)}
  .badge.owner{background:var(--chip-owner);color:var(--chip-owner-text)}
</style>
</head>
<body>
<h1>QR 스캐너</h1>

<div class="row">
  <button id="startQrBtn">QR 카메라 켜기</button>
  <button id="exportXlsxBtn">엑셀 내보내기</button>
  <button id="clearBtn">초기화</button>
  <label class="chk" title="체크 해제하면 사진 없이 즉시 저장합니다.">
    <input id="requirePhotoChk" type="checkbox" checked> 비품 사진 촬영
  </label>
  <span class="count" id="count">저장 0건</span>
</div>

<!-- 미리보기(공용) -->
<div id="previewHost">
  <div id="preview">
    <video id="video" playsinline muted></video>
    <canvas id="overlay"></canvas>
  </div>
</div>

<p id="msg">QR을 화면 중앙에 크게 맞춰주세요.</p>

<div class="card" id="infoCard">
  <h2>비품정보</h2>
  <div class="subtitle">스캔 즉시 아래 표와 비품 촬영 패널에 반영됩니다.</div>
  <table id="tbl"><tbody></tbody></table>

  <!-- 비품 촬영 패널 -->
  <div id="photoStep" class="photo-step">
    <div class="photo-head">QR 정상 인식됨 → 지금 비품 사진을 촬영하세요(처리용량 초과시 저장이 안될수 있습니다. 저장후 초기화를 하세요)</div>
    <div class="photo-grid">
      <div>
        <div class="photo-chips" id="photoChips"></div>
        <div class="hint">비품 전체가 보이도록 카메라를 맞춘 뒤 <strong>비품 사진 촬영</strong>을 누르세요.</div>
        <div class="actions">
          <button id="shotBtn" class="btn-primary">비품 사진 촬영</button>
          <button id="skipBtn" class="btn-ghost">사진 건너뛰기</button>
        </div>
      </div>
      <div class="photo-slot">
        <!-- 비디오를 옮기지 않고 캔버스에 미러링 -->
        <canvas id="photoLive"></canvas>
      </div>
    </div>
  </div>
</div>

<div class="card">
  <h2>최근 저장 목록</span></h2>
  <div class="subtitle">같은 항목을 다시 스캔해도 중복 저장하지 않고, 시간만 갱신합니다.</div>
  <div id="list" class="list"></div>
</div>

<!-- 라이브러리 -->
<script src="libs/jsQR.js?v={{ site.time | date: '%Y%m%d%H%M%S' }}"></script>
<script src="libs/FileSaver.min.js?v={{ site.time | date: '%Y%m%d%H%M%S' }}"></script>
<script src="libs/exceljs.min.js?v={{ site.time | date: '%Y%m%d%H%M%S' }}"></script>

<script>
(()=> {
  const DEBUG=false, TARGET=640, WARMUP_FRAMES=6;

  const startQrBtn=document.getElementById('startQrBtn');
  const exportXlsxBtn=document.getElementById('exportXlsxBtn');
  const clearBtn=document.getElementById('clearBtn');
  const requirePhotoChk=document.getElementById('requirePhotoChk');

  const previewHost=document.getElementById('previewHost');
  const preview=document.getElementById('preview');
  const video=document.getElementById('video');
  const overlay=document.getElementById('overlay');
  const ox=overlay.getContext('2d');

  const msg=document.getElementById('msg');
  const tbody=document.querySelector('#tbl tbody');
  const photoStep=document.getElementById('photoStep');
  const photoChips=document.getElementById('photoChips');
  const photoLive=document.getElementById('photoLive');
  const photoCtx=photoLive.getContext('2d', { willReadFrequently:true });
  const shotBtn=document.getElementById('shotBtn');
  const skipBtn=document.getElementById('skipBtn');
  const listEl=document.getElementById('list');
  const countEl=document.getElementById('count');

  let stream=null, running=false;
  let MODE='idle'; // idle | scan | photo
  let pendingParsed=null
  let photoRAF=null;

  // ---- 스토리지 ----
  let records=load(); renderList();
  function load(){ try{ return JSON.parse(localStorage.getItem('qr_records')||'[]'); }catch(_){ return []; } }
  function save(){ localStorage.setItem('qr_records', JSON.stringify(records)); }
  function nowKST(){
    const p=new Intl.DateTimeFormat('ko-KR',{timeZone:'Asia/Seoul',year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false}).formatToParts(new Date());
    const g=t=>p.find(x=>x.type===t)?.value||''; return `${g('year')}-${g('month')}-${g('day')} ${g('hour')}:${g('minute')}:${g('second')}`;
  }
  function esc(s){ return String(s??'').replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }
  function dedupeKey(o){ const id=(o.id||'').trim(); return id ? 'ID:'+id.toLowerCase() : 'RAW:'+String(o.raw||''); }
  function upsert(o){
    const k=dedupeKey(o), t=nowKST(); const i=records.findIndex(r=>r._key===k);
    if(i>=0) records[i]={...records[i], ...o, scanned_at_kst:t};
    else records.push({_key:k, ...o, scanned_at_kst:t});
    save(); renderList();
  }
  function renderList(){
    countEl.textContent=`저장 ${records.length}건`; listEl.innerHTML='';
    records.slice().reverse().forEach(r=>{
      const d=document.createElement('div'); d.className='item';
      d.innerHTML=`<div class="head"><div class="time mono">${r.scanned_at_kst}</div></div>
        <div class="badges">
          <span class="badge id">비품번호: ${esc(r.id)}</span>
          <span class="badge name">비품명: ${esc(r.name)}</span>
          <span class="badge loc">위치: ${esc(r.loc)}</span>
          <span class="badge owner">사용자: ${esc(r.owner)}</span>
        </div>`;
      listEl.appendChild(d);
    });
  }
  function setMsg(t){ msg.textContent=t||''; }

  // ---- 체크박스 상태 기억 ----
  const savedRequirePhoto = localStorage.getItem('require_photo');
  if (savedRequirePhoto !== null) requirePhotoChk.checked = savedRequirePhoto === '1';
  requirePhotoChk.addEventListener('change', () => {
    localStorage.setItem('require_photo', requirePhotoChk.checked ? '1' : '0');
  });

  // ---- 미리보기 표시 ----
  function showPreview(b){
    preview.style.display=b?'block':'none';
    video.style.display=b?'block':'none';
    overlay.style.display=(b && DEBUG)?'block':'none';
  }
  async function ensureVisible(){
    await new Promise(r=>requestAnimationFrame(()=>requestAnimationFrame(r)));
    try{ if(video.paused || video.readyState < HTMLMediaElement.HAVE_ENOUGH_DATA) await video.play(); }catch(_){}
    if(video.videoWidth && video.videoHeight){ overlay.width=video.videoWidth; overlay.height=video.videoHeight; }
  }

  // ---- 캔버스 미러 (촬영 패널 표시용) ----
  function startPhotoLive(){
    const vw=video.videoWidth||1280, vh=video.videoHeight||720;
    photoLive.width=vw; photoLive.height=vh;
    if(photoRAF) cancelAnimationFrame(photoRAF);
    const draw=()=>{
      if(MODE==='photo' && running && video.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA){
        photoCtx.drawImage(video,0,0,photoLive.width,photoLive.height);
      }
      photoRAF=requestAnimationFrame(draw);
    };
    photoRAF=requestAnimationFrame(draw);
  }
  function stopPhotoLive(){
    if(photoRAF) cancelAnimationFrame(photoRAF);
    photoRAF=null;
    photoCtx.clearRect(0,0,photoLive.width,photoLive.height);
  }

  // ---- 카메라 ----
  async function startCamera(){
    stream=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:{ideal:'environment'},width:{ideal:1280},height:{ideal:720}},
      audio:false
    });
    video.srcObject=null; video.load(); video.srcObject=stream;
    await new Promise(r=>{
      if(video.readyState>=HTMLMediaElement.HAVE_ENOUGH_DATA) return r();
      const ok=()=>r(); video.addEventListener('loadeddata',ok,{once:true}); video.addEventListener('canplay',ok,{once:true});
    });
    await video.play().catch(()=>{});
    overlay.width=video.videoWidth||640; overlay.height=video.videoHeight||480;
    running=true; showPreview(true);
  }
  function stopCamera(){
    try{ stream?.getTracks().forEach(t=>t.stop()); }catch(_){}
    stream=null; running=false;
    try{ video.pause(); }catch(_){}
    video.srcObject=null; video.load();
    showPreview(false); ox.clearRect(0,0,overlay.width,overlay.height);
  }

  // ---- QR 스캔 ----
  let accept={v:null,at:0};
  function canAccept(v){ const now=performance.now(); if(v && accept.v===v && now-accept.at<1200) return false; accept={v,at:now}; return true; }

  async function startQrScan(){
  MODE='scan'; 
  setMsg('QR을 화면 중앙에 크게 맞춰주세요…');

  if(preview.parentNode!==previewHost) previewHost.appendChild(preview);
  await startCamera(); 
  await ensureVisible();

  // QR 모드: video 보이기, photoLive 숨기기
  showPreview(true);
  photoLive.style.display='none';
  overlay.style.display='none';

  // BarcodeDetector 우선
  if('BarcodeDetector' in window){
    const det=new BarcodeDetector({formats:['qr_code']});
    (async function loop(){
      if(MODE!=='scan' || !running) return;
      try{
        const r=await det.detect(video); 
        const val=r&&r[0]?.rawValue;
        if(val && canAccept(val)) return onQrDetected(val);
      }catch(_){}
      requestAnimationFrame(loop);
    })();
  }

  // jsQR 폴백
  const c=document.createElement('canvas'); 
  const x=c.getContext('2d',{willReadFrequently:true});
  let frame=0;
  (function loop(){
    if(MODE!=='scan' || !running) return;
    if(video.readyState!==video.HAVE_ENOUGH_DATA) return requestAnimationFrame(loop);
    const vw=video.videoWidth||640, vh=video.videoHeight||480; 
    const s=Math.min(vw,vh); const sx=(vw-s)>>1, sy=(vh-s)>>1;
    c.width=TARGET; c.height=TARGET; 
    x.drawImage(video,sx,sy,s,s,0,0,TARGET,TARGET);
    if(frame++<WARMUP_FRAMES) return requestAnimationFrame(loop);
    const img=x.getImageData(0,0,TARGET,TARGET); 
    const qr=jsQR(img.data,TARGET,TARGET,{inversionAttempts:'attemptBoth'});
    if(qr && qr.data && canAccept(qr.data)) return onQrDetected(qr.data);
    requestAnimationFrame(loop);
  })();
}


  function parseQR(text){
    let obj={};
    try{ const j=JSON.parse(text); if(j && typeof j==='object') obj=j; }
    catch{
      if(text.includes('=')){
        text.split(';').forEach(p=>{const i=p.indexOf('='); if(i<0) return; obj[p.slice(0,i).trim()]=p.slice(i+1).trim();});
      }else if(text.includes(':')){
        const a=text.split(':'); if(a.length>=4){ obj.id=a[0].trim(); obj.name=a[1].trim(); obj.loc=a[2].trim(); obj.owner=a[3].trim(); }
      }
    }
    return { id:obj.id??'', name:obj.name??'', loc:obj.loc??'', owner:obj.owner??'', raw:text };
  }

  function renderTable(o){
    const rows=[['비품번호','id','id'],['비품명','name','name'],['위치','loc','loc'],['사용자','owner','owner']];
    tbody.innerHTML='';
    rows.forEach(([label,key,cls])=>{
      const tr=document.createElement('tr');
      const th=document.createElement('th'); th.className='key'; th.innerHTML=`<span class="chip ${cls}">${label}</span>`;
      const td=document.createElement('td'); td.textContent=o[key]??'';
      tr.append(th,td); tbody.appendChild(tr);
    });
  }
  function renderChips(o){
    photoChips.innerHTML=`<span class="chip id">비품번호: ${esc(o.id)}</span>
    <span class="chip name">비품명: ${esc(o.name)}</span>
    <span class="chip loc">위치: ${esc(o.loc)}</span>
    <span class="chip owner">사용자: ${esc(o.owner)}</span>`;
  }

  async function onQrDetected(val){
  const parsed=parseQR(val);
  renderTable(parsed);

  if(!requirePhotoChk.checked){
    stopCamera(); MODE='idle';
    upsert({...parsed, imgDataUrl:null});
    setMsg('사진 없이 저장했습니다.');
    return;
  }

  // 사진 필요: 상태 보관 + QR 미리보기(작게)
  pendingParsed=parsed;

  // 스캔만 중지
  MODE='photo';
  renderChips(parsed);
  photoStep.style.display='block';

  // ▶ QR 프리뷰 감추고 캔버스 켜기
  showPreview(false);             // video 숨김
  photoLive.style.display='block';

  await ensureVisible();
  startPhotoLive(); // 미러 시작
  setMsg('비품을 프레임에 맞춰 [비품 사진 촬영]을 눌러주세요.');
}


  // 캡처
  async function capture(videoEl, maxW=640){
  const vw = videoEl.videoWidth || 640;
  const vh = videoEl.videoHeight || 480;
  const s  = Math.min(1, maxW / vw);
  const w  = Math.round(vw * s);
  const h  = Math.round(vh * s);

  const c = document.createElement('canvas');
  c.width  = w;
  c.height = h;
  c.getContext('2d', {willReadFrequently:true}).drawImage(videoEl, 0, 0, w, h);

  // ✅ 품질 0.7로 조정 (기존 0.9보다 용량 줄어듦)
  return c.toDataURL('image/jpeg', 0.7);
}


  // ---- 버튼 동작 ----
  startQrBtn.onclick = async () => {
  if (running) {
    // 이미 켜져있으면 → 끄기
    stopPhotoLive();
    stopCamera();
    MODE = 'idle';
    setMsg('카메라를 끔');
    startQrBtn.textContent = 'QR 카메라 켜기';   // 🔴 버튼 텍스트 변경
    return;
  }

  try {
    await startQrScan();
    startQrBtn.textContent = 'QR 카메라 끄기';   // 🟢 켰을 때 변경
  } catch (e) {
    setMsg('카메라 오류: ' + (e.name || e));
    stopPhotoLive();
    stopCamera();
    MODE = 'idle';
    startQrBtn.textContent = 'QR 카메라 켜기';   // 에러 시도 기본으로
  }
};


  shotBtn.onclick=async()=>{
  if(MODE!=='photo' || !pendingParsed) return;
  const img=await capture(video, 960).catch(()=>null);

  stopPhotoLive();
  photoLive.style.display='none';   // 캔버스 감춤
  stopCamera(); 
  MODE='idle';

  upsert({...pendingParsed, imgDataUrl:img});
  pendingParsed=null;
  photoStep.style.display='none';
  setMsg('저장 완료');
  
  startQrBtn.textContent = 'QR 카메라 켜기';
};

skipBtn.onclick=async()=>{
  if(MODE!=='photo' || !pendingParsed) return;

  stopPhotoLive();
  photoLive.style.display='none';   // 캔버스 감춤
  stopCamera(); 
  MODE='idle';

  upsert({...pendingParsed, imgDataUrl:null});
  pendingParsed=null;
  photoStep.style.display='none';
  setMsg('사진 없이 저장했습니다.');
  startQrBtn.textContent = 'QR 카메라 켜기';
};


  clearBtn.onclick=()=>{
    if(!confirm('저장된 모든 레코드를 삭제할까요?')) return;
    records=[]; save(); renderList(); tbody.innerHTML=''; setMsg('초기화 완료');
  };

  // ---- XLSX 내보내기 (사진 포함) ----
  exportXlsxBtn.onclick = async () => {
  if(records.length===0){ setMsg('내보낼 데이터가 없습니다.'); return; }

  const wb = new ExcelJS.Workbook();
  const ws = wb.addWorksheet('QR Scans');

  // ✅ QR미리보기 컬럼 제거 (비품사진만 유지)
  ws.columns = [
    {header:'스캔시각', width:22},
    {header:'비품번호', width:18},
    {header:'비품명',   width:28},
    {header:'위치',     width:18},
    {header:'사용자',   width:18},
    {header:'비품사진', width:28}
  ];
  ws.getRow(1).height = 22;

  let rowIdx = 2;
  for(const r of records){
    ws.addRow([
      r.scanned_at_kst||'',
      r.id||'',
      r.name||'',
      r.loc||'',
      r.owner||'',
      '' // 비품사진 자리
    ]);
    ws.getRow(rowIdx).height = 95;

    // ✅ 비품사진만 삽입
    if (r.imgDataUrl) {
      const imgId = wb.addImage({
        base64: r.imgDataUrl.split(',')[1],
        extension: 'jpeg'
      });
      // 0-based 좌표: 비품사진은 6번째 컬럼 → col:5
      ws.addImage(imgId, { tl:{ col:5, row:rowIdx-1 }, ext:{ width:180, height:120 } });
    }

    rowIdx++;
  }

  const buf = await wb.xlsx.writeBuffer();
  saveAs(
    new Blob([buf],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}),
    `qr_scans_${new Date().toISOString().slice(0,10)}.xlsx`
  );
};

})();
</script>
</body>
</html>

<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>디와이덕양 비품관리 (ZXing 단독)</title>
<style>
  body{font-family:system-ui,malgun gothic,apple sd gothic neo,arial;max-width:980px;margin:28px auto;padding:0 16px;background:#fff;color:#16181b}
  h1{font-size:22px;margin:14px 0}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:12px 0}
  button{font-size:16px;padding:10px 16px;border:1px solid #e6e8eb;border-radius:10px;background:#fff;cursor:pointer}
  button:hover{border-color:#c9ced6}
  #msg{margin:8px 2px;color:#475569}
  #preview{position:relative;width:100%;max-width:560px;aspect-ratio:1/1;overflow:hidden;border:1px solid #e6e8eb;border-radius:12px;margin:10px 0}
  #video{width:100%;height:100%;object-fit:cover;border-radius:12px}
  table{border-collapse:separate;border-spacing:0;width:100%;margin-top:10px}
  th,td{padding:10px;border-bottom:1px solid #e6e8eb;text-align:left}
  th{background:#f9fafb;width:100px}
</style>
</head>
<body>
<h1>QR 스캐너 (ZXing 단독)</h1>

<div class="row">
  <button id="startQrBtn">🎥 QR 카메라 ON</button>
  <button id="stopQrBtn">카메라 OFF</button>
</div>

<div id="preview">
  <video id="video" playsinline muted></video>
</div>

<p id="msg">QR을 화면 중앙에 맞춰주세요.</p>

<h2>비품정보</h2>
<table id="tbl"><tbody></tbody></table>

<!-- ZXing 라이브러리 -->
<script src="libs/zxing.min.js"></script>
<script>
  window.ZXing = window.ZXing || window.ZXingBrowser;  // ★ 보정
</script>
<script>
(()=> {
  const video = document.getElementById('video');
  const msg = document.getElementById('msg');
  const tbody = document.querySelector('#tbl tbody');

  let stream = null;
  let zxingReader = null;
  let lastZXingVal = '';

  // QR 문자열 파싱
  function parseQR(text){
    const raw=String(text||'').trim();
    const out={id:'',name:'',loc:'',owner:'',raw};
    const parts = raw.split(/[;]+/).map(s=>s.trim()).filter(Boolean);
    for(const p of parts){
      const i=p.indexOf('=');
      if(i<0) continue;
      const key=p.slice(0,i).trim().toLowerCase();
      let val=p.slice(i+1).trim();
      try{ val = decodeURIComponent(val); }catch(_){}
      if(key==='id') out.id=val;
      else if(key==='name') out.name=val;
      else if(key==='loc'||key==='location') out.loc=val;
      else if(key==='owner'||key==='user') out.owner=val;
    }
    return out;
  }

  // 테이블에 표시
  function renderTable(o){
    const rows=[['비품번호','id'],['비품명','name'],['위치','loc'],['사용자','owner']];
    tbody.innerHTML='';
    rows.forEach(([label,key])=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<th>${label}</th><td>${o[key]||''}</td>`;
      tbody.appendChild(tr);
    });
  }

  // ZXing 시작
  async function startZXing(){
    if(!window.ZXing || !ZXing.BrowserMultiFormatReader){
      msg.textContent = '❌ ZXing 로드 실패';
      return;
    }
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:"environment" }, audio:false });
      video.srcObject = stream;
      await video.play();

      zxingReader = new ZXing.BrowserMultiFormatReader();
      await zxingReader.decodeFromStream(stream, video, (result, err)=>{
        if(!result || !result.getText) return;
        const raw = result.getText();

        if (raw === lastZXingVal) return; // 같은 값 무시
        lastZXingVal = raw;

        msg.textContent = `✅ ZXING 인식됨: ${raw}`;
        const parsed = parseQR(raw);
        renderTable(parsed);
      });
    } catch(e){
      msg.textContent = '카메라 오류: '+e;
    }
  }

  // ZXing 중지
  function stopZXing(){
    try { if(zxingReader) zxingReader.reset(); } catch(_){}
    zxingReader = null;
    if(stream){
      stream.getTracks().forEach(t=>t.stop());
      stream = null;
    }
    video.srcObject = null;
    msg.textContent = '카메라 중지됨';
  }

  // 버튼
  document.getElementById('startQrBtn').onclick = ()=>{
    lastZXingVal='';
    startZXing();
  };
  document.getElementById('stopQrBtn').onclick = ()=>{
    stopZXing();
  };

  // 페이지 벗어날 때 카메라 정리
  window.addEventListener("pagehide", stopZXing);
  window.addEventListener("beforeunload", stopZXing);
})();
</script>
</body>
</html>

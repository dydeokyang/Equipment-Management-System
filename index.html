<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ë””ì™€ì´ë•ì–‘ ë¹„í’ˆê´€ë¦¬ (ZXing ë‹¨ë…)</title>
<style>
  body{font-family:system-ui,malgun gothic,apple sd gothic neo,arial;max-width:980px;margin:28px auto;padding:0 16px;background:#fff;color:#16181b}
  h1{font-size:22px;margin:14px 0}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:12px 0}
  button{font-size:16px;padding:10px 16px;border:1px solid #e6e8eb;border-radius:10px;background:#fff;cursor:pointer}
  button:hover{border-color:#c9ced6}
  #msg{margin:8px 2px;color:#475569}
  #preview{position:relative;width:100%;max-width:560px;aspect-ratio:1/1;overflow:hidden;border:1px solid #e6e8eb;border-radius:12px;margin:10px 0}
  #video{width:100%;height:100%;object-fit:cover;border-radius:12px}
  table{border-collapse:separate;border-spacing:0;width:100%;margin-top:10px}
  th,td{padding:10px;border-bottom:1px solid #e6e8eb;text-align:left}
  th{background:#f9fafb;width:100px}
</style>
</head>
<body>
<h1>QR ìŠ¤ìºë„ˆ (ZXing ë‹¨ë…)</h1>

<div class="row">
  <button id="startQrBtn">ğŸ¥ QR ì¹´ë©”ë¼ ON</button>
  <button id="stopQrBtn">ì¹´ë©”ë¼ OFF</button>
</div>

<div id="preview">
  <video id="video" playsinline muted></video>
</div>

<p id="msg">QRì„ í™”ë©´ ì¤‘ì•™ì— ë§ì¶°ì£¼ì„¸ìš”.</p>

<h2>ë¹„í’ˆì •ë³´</h2>
<table id="tbl"><tbody></tbody></table>

<!-- ZXing ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<script src="libs/zxing.min.js"></script>
<script>
  window.ZXing = window.ZXing || window.ZXingBrowser;  // â˜… ë³´ì •
</script>
<script>
(()=> {
  const video = document.getElementById('video');
  const msg = document.getElementById('msg');
  const tbody = document.querySelector('#tbl tbody');

  let stream = null;
  let zxingReader = null;
  let lastZXingVal = '';

  // QR ë¬¸ìì—´ íŒŒì‹±
  function parseQR(text){
    const raw=String(text||'').trim();
    const out={id:'',name:'',loc:'',owner:'',raw};
    const parts = raw.split(/[;]+/).map(s=>s.trim()).filter(Boolean);
    for(const p of parts){
      const i=p.indexOf('=');
      if(i<0) continue;
      const key=p.slice(0,i).trim().toLowerCase();
      let val=p.slice(i+1).trim();
      try{ val = decodeURIComponent(val); }catch(_){}
      if(key==='id') out.id=val;
      else if(key==='name') out.name=val;
      else if(key==='loc'||key==='location') out.loc=val;
      else if(key==='owner'||key==='user') out.owner=val;
    }
    return out;
  }

  // í…Œì´ë¸”ì— í‘œì‹œ
  function renderTable(o){
    const rows=[['ë¹„í’ˆë²ˆí˜¸','id'],['ë¹„í’ˆëª…','name'],['ìœ„ì¹˜','loc'],['ì‚¬ìš©ì','owner']];
    tbody.innerHTML='';
    rows.forEach(([label,key])=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<th>${label}</th><td>${o[key]||''}</td>`;
      tbody.appendChild(tr);
    });
  }

  // ZXing ì‹œì‘
  async function startZXing(){
    if(!window.ZXing || !ZXing.BrowserMultiFormatReader){
      msg.textContent = 'âŒ ZXing ë¡œë“œ ì‹¤íŒ¨';
      return;
    }
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:"environment" }, audio:false });
      video.srcObject = stream;
      await video.play();

      zxingReader = new ZXing.BrowserMultiFormatReader();
      await zxingReader.decodeFromStream(stream, video, (result, err)=>{
        if(!result || !result.getText) return;
        const raw = result.getText();

        if (raw === lastZXingVal) return; // ê°™ì€ ê°’ ë¬´ì‹œ
        lastZXingVal = raw;

        msg.textContent = `âœ… ZXING ì¸ì‹ë¨: ${raw}`;
        const parsed = parseQR(raw);
        renderTable(parsed);
      });
    } catch(e){
      msg.textContent = 'ì¹´ë©”ë¼ ì˜¤ë¥˜: '+e;
    }
  }

  // ZXing ì¤‘ì§€
  function stopZXing(){
    try { if(zxingReader) zxingReader.reset(); } catch(_){}
    zxingReader = null;
    if(stream){
      stream.getTracks().forEach(t=>t.stop());
      stream = null;
    }
    video.srcObject = null;
    msg.textContent = 'ì¹´ë©”ë¼ ì¤‘ì§€ë¨';
  }

  // ë²„íŠ¼
  document.getElementById('startQrBtn').onclick = ()=>{
    lastZXingVal='';
    startZXing();
  };
  document.getElementById('stopQrBtn').onclick = ()=>{
    stopZXing();
  };

  // í˜ì´ì§€ ë²—ì–´ë‚  ë•Œ ì¹´ë©”ë¼ ì •ë¦¬
  window.addEventListener("pagehide", stopZXing);
  window.addEventListener("beforeunload", stopZXing);
})();
</script>
</body>
</html>

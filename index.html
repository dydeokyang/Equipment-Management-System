<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ë””ì™€ì´ë•ì–‘ ë¹„í’ˆê´€ë¦¬</title>
<style>
  :root{
    --bg:#fff; --fg:#16181b; --muted:#667085; --border:#e6e8eb; --shadow:0 4px 14px rgba(0,0,0,.08);
    --chip-id:#eef2ff; --chip-id-text:#1d4ed8; --chip-name:#ecfdf5; --chip-name-text:#065f46;
    --chip-loc:#fff7ed; --chip-loc-text:#9a3412; --chip-owner:#fef2f2; --chip-owner-text:#b91c1c;
    --focus:#0ea5e9; --okbg:#ecfdf5; --ok:#065f46;
  }
  body{font-family:system-ui,malgun gothic,apple sd gothic neo,arial;background:var(--bg);color:var(--fg);max-width:980px;margin:28px auto;padding:0 16px}
  h1{font-size:22px;margin:14px 0}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:12px 0}
  button{font-size:16px;padding:10px 16px;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer}
  button:hover{border-color:#c9ced6}
  label.chk{display:flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
  label.chk input{width:18px;height:18px}
  .count{margin-left:auto;color:#333;font-size:14px}
  #msg{margin:8px 2px;color:#475569}

  /* ë¯¸ë¦¬ë³´ê¸° ê³µìš© */
  #previewHost{margin:10px 0}
  #preview{position:relative;width:100%;max-width:560px;aspect-ratio:1/1;overflow:hidden;border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);display:none;background:transparent}
  #video,#overlay{position:absolute;inset:0;width:100%;height:100%;display:none;object-fit:cover;object-position:center;pointer-events:none;background:transparent}

  .card{background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:16px;margin:16px 0}
  .subtitle{color:var(--muted);font-size:13px;margin-top:-6px;margin-bottom:10px}
  table{border-collapse:separate;border-spacing:0;width:100%}
  th,td{padding:12px;border-bottom:1px solid var(--border);text-align:left;word-break:break-all}
  tbody tr:nth-child(even){background:#fcfdff}
  tbody tr:last-child td, tbody tr:last-child th{border-bottom:0}
  th.key{font-weight:600;background:transparent;padding:6px 0}
  .chip{display:inline-block;padding:4px 10px;border-radius:999px;font-size:13px}
  .chip.id{background:var(--chip-id);color:var(--chip-id-text)}
  .chip.name{background:var(--chip-name);color:var(--chip-name-text)}
  .chip.loc{background:var(--chip-loc);color:var(--chip-loc-text)}
  .chip.owner{background:var(--chip-owner);color:var(--chip-owner-text)}

  /* ë¹„í’ˆ ì´¬ì˜ íŒ¨ë„ */
  .photo-step{display:none;margin-top:14px;border:2px dashed var(--focus);border-radius:12px;padding:12px}
  .photo-head{display:flex;align-items:center;gap:10px;margin-bottom:10px;background:var(--okbg);color:var(--ok);border:1px solid #cce7dd;padding:8px 10px;border-radius:8px;font-weight:600}
  .photo-grid{display:grid;grid-template-columns:1.15fr .85fr;gap:14px;align-items:start}
  @media (max-width:900px){ .photo-grid{grid-template-columns:1fr} }
  .photo-chips{display:flex;flex-wrap:wrap;gap:8px}
  .photo-slot{position:relative;width:100%;aspect-ratio:4/3;border-radius:10px;overflow:hidden;border:2px solid var(--focus);background:transparent}
  .photo-slot #photoLive{display:block;width:100%;height:100%}
  .hint{font-size:13px;color:#475569;margin-top:6px}
  .actions{display:flex;gap:10px;margin-top:8px;flex-wrap:wrap}

  .list{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:760px){ .list{grid-template-columns:1fr} }
  .item{border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff;box-shadow:var(--shadow)}
  .item .head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .item .time{font-size:13px;color:#334155;background:#f1f5f9;border-radius:6px;padding:4px 8px}
  .badges{display:flex;flex-wrap:wrap;gap:6px}
  .badge{font-size:12px;border-radius:999px;padding:3px 8px}
  .badge.id{background:var(--chip-id);color:var(--chip-id-text)}
  .badge.name{background:var(--chip-name);color:var(--chip-name-text)}
  .badge.loc{background:var(--chip-loc);color:var(--chip-loc-text)}
  .badge.owner{background:var(--chip-owner);color:var(--chip-owner-text)}

  @keyframes pulseBorder { 0%{box-shadow:0 0 0 0 rgba(14,165,233,.45)} 70%{box-shadow:0 0 0 12px rgba(14,165,233,0)} 100%{box-shadow:0 0 0 0 rgba(14,165,233,0)} }
  .photo-step.pulse { animation: pulseBorder 1.2s ease-out 2; }

  /* íŒŒë€ ë©”ì¸ ë²„íŠ¼ */
  button.btn-primary{
    background:linear-gradient(135deg,#3b82f6,#2563eb);
    color:#fff;border:none;font-weight:700;
    box-shadow:0 4px 12px rgba(37,99,235,.35);
    transition:transform .15s ease, box-shadow .15s ease, filter .15s ease;
  }
  button.btn-primary:hover{ background:linear-gradient(135deg,#60a5fa,#3b82f6); box-shadow:0 6px 16px rgba(37,99,235,.45); transform:translateY(-2px) }
  button.btn-primary:active{ transform:translateY(0); box-shadow:0 2px 8px rgba(37,99,235,.3) }
  button.btn-primary:focus-visible{ outline:2px solid #93c5fd; outline-offset:2px }
  @media (prefers-color-scheme: dark){
    button.btn-primary{ background:linear-gradient(135deg,#60a5fa,#3b82f6); box-shadow:0 4px 14px rgba(59,130,246,.55) }
    button.btn-primary:hover{ background:linear-gradient(135deg,#93c5fd,#60a5fa) }
  }

  /* ì´¬ì˜/ê±´ë„ˆë›°ê¸° ë²„íŠ¼: ëª¨ë°”ì¼ í•œ ì¤„ ìœ ì§€ */
  .photo-grid .actions{ display:flex; gap:8px; flex-wrap:nowrap; align-items:stretch }
  .photo-grid .actions button{ flex:1 1 0; min-width:0; white-space:nowrap }
  @media (max-width:380px){ .photo-grid .actions{gap:6px} .photo-grid .actions button{font-size:14px;padding:9px 10px} }
  @media (max-width:320px){ .photo-grid .actions{ overflow-x:auto } }

  /* ì»¤ìŠ¤í…€ í™•ì¸ ëª¨ë‹¬ (ì˜ˆë¹„) */
  #confirmMask{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:9999}
  #confirmBox{background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.15);max-width:420px;width:92%;padding:16px}
  #confirmBox h3{margin:0 0 8px 0;font-size:16px}
  #confirmBox p{margin:0 0 14px 0;color:#475569;white-space:pre-line}
  #confirmBox .actions{display:flex;gap:8px;justify-content:flex-end}
  #confirmBox .btn{padding:10px 14px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;cursor:pointer}
  #confirmBox .btn.primary{background:#16a34a;color:#fff;border:none}
</style>
</head>
<body>
<h1>QR ìŠ¤ìºë„ˆ</h1>

<div class="row">
  <button id="startQrBtn" class="btn-primary">ğŸ¥ QR ì¹´ë©”ë¼ ON</button>
  <button id="exportXlsxBtn">ì—‘ì…€ ë‚´ë³´ë‚´ê¸°</button>
  <button id="clearBtn">ì´ˆê¸°í™”</button>
  <label class="chk" title="ì²´í¬ í•´ì œí•˜ë©´ ì‚¬ì§„ ì—†ì´ ì¦‰ì‹œ ì €ì¥í•©ë‹ˆë‹¤.">
    <input id="requirePhotoChk" type="checkbox" checked> ë¹„í’ˆ ì‚¬ì§„ ì´¬ì˜
  </label>
  <span class="count" id="count">ì €ì¥ 0ê±´</span>
</div>

<div id="previewHost">
  <div id="preview">
    <video id="video" playsinline muted></video>
    <canvas id="overlay"></canvas>
  </div>
</div>

<p id="msg">QRì„ í™”ë©´ ì¤‘ì•™ì— í¬ê²Œ ë§ì¶°ì£¼ì„¸ìš”.</p>

<div class="card" id="infoCard">
  <h2>ë¹„í’ˆì •ë³´</h2>
  <div class="subtitle">ìŠ¤ìº” ì¦‰ì‹œ ì•„ë˜ í‘œì™€ ë¹„í’ˆ ì´¬ì˜ íŒ¨ë„ì— ë°˜ì˜ë©ë‹ˆë‹¤.</div>
  <table id="tbl"><tbody></tbody></table>

  <div id="photoStep" class="photo-step">
    <div class="photo-head">QR ì •ìƒ ì¸ì‹ë¨ â†’ ì§€ê¸ˆ ë¹„í’ˆ ì‚¬ì§„ì„ ì´¬ì˜í•˜ì„¸ìš”(ì²˜ë¦¬ìš©ëŸ‰ ì´ˆê³¼ì‹œ ì €ì¥ì´ ì•ˆë ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì €ì¥í›„ ì´ˆê¸°í™”ë¥¼ í•˜ì„¸ìš”)</div>
    <div class="photo-grid">
      <div>
        <div class="photo-chips" id="photoChips"></div>
        <div class="hint">ë¹„í’ˆ ì „ì²´ê°€ ë³´ì´ë„ë¡ ì¹´ë©”ë¼ë¥¼ ë§ì¶˜ ë’¤ <strong>ë¹„í’ˆ ì‚¬ì§„ ì´¬ì˜</strong>ì„ ëˆ„ë¥´ì„¸ìš”.</div>
        <div class="actions">
          <button id="shotBtn" class="btn-primary">ë¹„í’ˆ ì‚¬ì§„ ì´¬ì˜ ğŸ“·</button>
          <button id="skipBtn" class="btn-ghost">ì‚¬ì§„ ê±´ë„ˆë›°ê¸°</button>
        </div>
      </div>
      <div class="photo-slot">
        <canvas id="photoLive"></canvas>
      </div>
    </div>
  </div>
</div>

<div class="card">
  <h2>ìµœê·¼ ì €ì¥ ëª©ë¡</h2>
  <div class="subtitle">ê°™ì€ í•­ëª©ì„ ë‹¤ì‹œ ìŠ¤ìº”í•´ë„ ì¤‘ë³µ ì €ì¥í•˜ì§€ ì•Šê³ , ì‹œê°„ë§Œ ê°±ì‹ í•©ë‹ˆë‹¤.</div>
  <div id="list" class="list"></div>
</div>

<!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<script src="libs/jsQR.js?v={{ site.time | date: '%Y%m%d%H%M%S' }}"></script>
<script src="libs/FileSaver.min.js?v={{ site.time | date: '%Y%m%d%H%M%S' }}"></script>
<script src="libs/exceljs.min.js?v={{ site.time | date: '%Y%m%d%H%M%S' }}"></script>

<script>
(()=> {
  // ===== ìš”ì†Œ =====
  const startQrBtn = document.getElementById('startQrBtn');
  const exportXlsxBtn = document.getElementById('exportXlsxBtn');
  const clearBtn = document.getElementById('clearBtn');
  const requirePhotoChk = document.getElementById('requirePhotoChk');
  const previewHost = document.getElementById('previewHost');
  const preview = document.getElementById('preview');
  let   video = document.getElementById('video'); // â† hard reset ìœ„í•´ let
  const overlay = document.getElementById('overlay');
  const ox = overlay.getContext('2d');
  const msg = document.getElementById('msg');
  const tbody = document.querySelector('#tbl tbody');
  const photoStep = document.getElementById('photoStep');
  const photoChips = document.getElementById('photoChips');
  const photoLive = document.getElementById('photoLive');
  const photoCtx = photoLive.getContext('2d',{willReadFrequently:true});
  const shotBtn = document.getElementById('shotBtn');
  const skipBtn = document.getElementById('skipBtn');
  const listEl = document.getElementById('list');
  const countEl = document.getElementById('count');

  // ===== ìƒíƒœ =====
  const DEBUG=false, TARGET=640, WARMUP_FRAMES=6;
  let stream=null, running=false;
  let MODE='idle'; // idle | scan | photo
  let pendingParsed=null, photoRAF=null;

  // í•˜ë“œ ë¦¬ì…‹/ì›Œì¹˜ë…/ìŠ¤ìº” ì„¸ì…˜
  let scanSessionId=0, watchdogTimer=null;
  let lastVideoTime = 0, stillTicks = 0;
  let lastFrameTS=0, lastRestartAt=0, lastGoodDeviceId=null;

  const HEARTBEAT_MS=700, FREEZE_TICKS=8;
  const MIN_RESTART_GAP_MS=15000, MAX_STALL_S=4.0;

  // ===== ìœ í‹¸ =====
  const isMobile = (()=>{try{
    return window.matchMedia?.('(pointer:coarse)')?.matches || /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent);
  }catch(_){return false;}})();
  function smoothScrollTo(el, offset=0){
    if(!el) return; const r=el.getBoundingClientRect();
    window.scrollTo({top: window.pageYOffset + r.top + offset, behavior:'smooth'});
  }
  function setMsg(t){ msg.textContent=t||''; }
  function esc(s){ return String(s??'').replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }
  function nowKST(){
    const p=new Intl.DateTimeFormat('ko-KR',{timeZone:'Asia/Seoul',year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false}).formatToParts(new Date());
    const g=t=>p.find(x=>x.type===t)?.value||''; return `${g('year')}-${g('month')}-${g('day')} ${g('hour')}:${g('minute')}:${g('second')}`;
  }
  function scrollToTop(){ window.scrollTo({ top: 0, behavior: 'smooth' }); }

  // ===== (ì¶”ê°€) ì•ˆì „ ë””ì½”ë”©/ë³µêµ¬ ìœ í‹¸ =====
  function countHangul(s){ return (String(s).match(/[\uac00-\ud7a3]/g)||[]).length; }
  function countReplacement(s){ return (String(s).match(/\uFFFD/g)||[]).length; }
  function latin1Bytes(s){ const u8=new Uint8Array(s.length); for(let i=0;i<s.length;i++) u8[i]=s.charCodeAt(i)&0xFF; return u8; }
  function tryDecoders(raw){
    const cand = [];
    const txt = String(raw??'');
    cand.push({how:'raw', s:txt});
    try{ cand.push({how:'decodeURIComponent', s:decodeURIComponent(txt)}); }catch(_){}
    try{ cand.push({how:'escapeâ†’decodeURIComponent', s:decodeURIComponent(escape(txt))}); }catch(_){}
    try{
      if('TextDecoder' in window){
        const td = new TextDecoder('euc-kr');
        cand.push({how:'euc-kr(TextDecoder)', s:td.decode(latin1Bytes(txt))});
      }
    }catch(_){}
    return cand;
  }
  function pickBest(cands){
    let best=cands[0], score=-1;
    for(const c of cands){
      const s = c.s ?? '';
      const hangul = countHangul(s);
      const rep = countReplacement(s);
      const asciiKeep = (s.match(/[A-Za-z0-9_\- .,:;=]/g)||[]).length;
      const sc = hangul*5 + asciiKeep*0.2 - rep*10;
      if(sc>score){ score=sc; best=c; }
    }
    return best;
  }
  function safeKoreanDecode(v){ return pickBest(tryDecoders(v)).s; }

  // ===== ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ =====
  let records=load(); renderList();
  function load(){ try{ return JSON.parse(localStorage.getItem('qr_records')||'[]'); }catch(_){ return []; } }
  function save(){ localStorage.setItem('qr_records', JSON.stringify(records)); }
  function dedupeKey(o){ const id=(o.id||'').trim(); return id ? 'ID:'+id.toLowerCase() : 'RAW:'+String(o.raw||''); }
  function upsert(o){
    const k=dedupeKey(o), t=nowKST(); const i=records.findIndex(r=>r._key===k);
    if(i>=0) records[i]={...records[i], ...o, scanned_at_kst:t};
    else records.push({_key:k, ...o, scanned_at_kst:t});
    save(); renderList();
  }
  function renderList(){
    countEl.textContent=`ì €ì¥ ${records.length}ê±´`; listEl.innerHTML='';
    records.slice().reverse().forEach(r=>{
      const d=document.createElement('div'); d.className='item';
      d.innerHTML=`<div class="head"><div class="time mono">${r.scanned_at_kst}</div></div>
      <div class="badges">
        <span class="badge id">ë¹„í’ˆë²ˆí˜¸: ${esc(r.id)}</span>
        <span class="badge name">ë¹„í’ˆëª…: ${esc(r.name)}</span>
        <span class="badge loc">ìœ„ì¹˜: ${esc(r.loc)}</span>
        <span class="badge owner">ì‚¬ìš©ì: ${esc(r.owner)}</span>
      </div>`;
      listEl.appendChild(d);
    });
  }

  // ===== ì¸ì‹ë¥  ë³´ê°•ìš© ìœ í‹¸ =====
  const TARGET_STEPS = [640, 800, 1024];
  function tryDecode(videoEl, opts, cache){
    const { width, full=false, centerCrop=false, boost=false } = opts;
    const { c, x } = cache || (()=>{ const c=document.createElement('canvas'); const x=c.getContext('2d',{willReadFrequently:true}); return {c,x}; })();
    const vw=videoEl.videoWidth||640, vh=videoEl.videoHeight||480;
    let sx=0, sy=0, sw=vw, sh=vh;

    if(!full){
      const s=Math.min(vw,vh); sx=(vw-s)/2; sy=(vh-s)/2; sw=sh=s;
      if(centerCrop){ const k=0.72; sx+=s*(1-k)/2; sy+=s*(1-k)/2; sw=sh=s*k; }
      c.width=width; c.height=width;
    }else{
      const outW=width, outH=Math.round(outW*vh/vw);
      c.width=outW; c.height=outH;
    }

    x.imageSmoothingEnabled=false;
    x.filter = boost ? 'contrast(140%) brightness(112%)' : 'none';
    x.drawImage(videoEl, sx, sy, sw, sh, 0, 0, c.width, c.height);
    const img=x.getImageData(0,0,c.width,c.height);
    return jsQR(img.data, c.width, c.height, { inversionAttempts:'attemptBoth' });
  }

  // ë¬¸ìì—´ì— id= í‚¤ê°€ ìˆëŠ”ì§€ ë¹ ë¥´ê²Œ ì²´í¬(ì¡°ê¸ˆ ê´€ëŒ€í•˜ê²Œ)
  function hasIdField(s){ return /(^|[;?&])\s*id\s*=/.test(String(s)); }

  // ===== ì´¬ì˜ íŒ¨ë„ ì œì–´ =====
  function hidePhotoPanel(){
    photoStep.style.display='none';
    photoStep.classList.remove('pulse');
    pendingParsed=null;
    stopPhotoLive();
  }

  // ===== ì²´í¬ë°•ìŠ¤ ê¸°ì–µ =====
  const savedRequirePhoto = localStorage.getItem('require_photo');
  if (savedRequirePhoto !== null) requirePhotoChk.checked = savedRequirePhoto === '1';
  requirePhotoChk.addEventListener('change', () => {
    localStorage.setItem('require_photo', requirePhotoChk.checked ? '1' : '0');
  });

  // ===== ë¯¸ë¦¬ë³´ê¸° =====
  function showPreview(b){
    preview.style.display=b?'block':'none';
    video.style.display=b?'block':'none';
    overlay.style.display=(b && DEBUG)?'block':'none';
  }
  async function ensureVisible(){
    await new Promise(r=>requestAnimationFrame(()=>requestAnimationFrame(r)));
    try{ if(video.paused || video.readyState < HTMLMediaElement.HAVE_ENOUGH_DATA) await video.play(); }catch(_){}
    if(video.videoWidth && video.videoHeight){ overlay.width=video.videoWidth; overlay.height=video.videoHeight; }
  }

  // ===== ìº”ë²„ìŠ¤ ë¯¸ëŸ¬(ì´¬ì˜ ì•ˆë‚´) =====
  function startPhotoLive(){
    const vw = video.videoWidth || 1280;
    const baseW = Math.min(960, vw);
    const baseH = Math.round(baseW * 3/4);
    photoLive.width = baseW; photoLive.height = baseH;

    if(photoRAF) cancelAnimationFrame(photoRAF);
    const draw=()=>{
      if(MODE==='photo' && running && video.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA){
        drawVideoToCanvas4x3(photoCtx, video);
      }
      photoRAF=requestAnimationFrame(draw);
    };
    photoRAF=requestAnimationFrame(draw);
  }
  function stopPhotoLive(){
    if(photoRAF) cancelAnimationFrame(photoRAF);
    photoRAF=null;
    photoCtx.clearRect(0,0,photoLive.width,photoLive.height);
  }
  function drawVideoToCanvas4x3(ctx, videoEl){
    const vw = videoEl.videoWidth || 1280;
    const vh = videoEl.videoHeight || 720;
    const dstW = ctx.canvas.width, dstH = ctx.canvas.height;
    const targetAR = 4/3, srcAR = vw/vh;
    let sx=0, sy=0, sw=vw, sh=vh;
    if (srcAR > targetAR){ sw=Math.round(vh*targetAR); sx=Math.round((vw-sw)/2); }
    else if (srcAR < targetAR){ sh=Math.round(vw/targetAR); sy=Math.round((vh-sh)/2); }
    ctx.drawImage(videoEl, sx, sy, sw, sh, 0, 0, dstW, dstH);
  }

  // ===== ë¹„ë””ì˜¤ ìš”ì†Œ/ì›Œì¹˜ë…/í”„ë ˆì„í‹±ì»¤ =====
  function recreateVideoElement(){
    const old = document.getElementById('video');
    const neu = old.cloneNode(false);
    neu.id='video'; neu.setAttribute('playsinline',''); neu.setAttribute('muted','');
    neu.playsInline=true; neu.muted=true;
    old.replaceWith(neu);
    return neu;
  }
  function startFrameTicker(videoEl){
    if (!('requestVideoFrameCallback' in HTMLVideoElement.prototype)) return;
    const tick = (_t, metadata)=>{
      lastFrameTS = metadata?.mediaTime || performance.now()/1000;
      if (running) videoEl.requestVideoFrameCallback(tick);
    };
    videoEl.requestVideoFrameCallback(tick);
  }
  function stopFrameTicker(){ lastFrameTS=0; }

  function startWatchdog(){
    stopWatchdog();
    watchdogTimer=setInterval(async()=>{
      if(!running) return;
      if(document.visibilityState!=='visible' || !document.hasFocus?.()) return;
      if(MODE==='photo') return;
      if(video.readyState < HTMLMediaElement.HAVE_CURRENT_DATA) return;
      if(performance.now()-lastRestartAt < MIN_RESTART_GAP_MS) return;

      if('requestVideoFrameCallback' in HTMLVideoElement.prototype){
        const nowS = performance.now()/1000;
        const stallS = nowS - (lastFrameTS||nowS);
        if (stallS>=MAX_STALL_S || !isStreamHealthy()){
          await forceHardRestart('êµ¬ë™ ì§€ì—°(rVFC)');
        }
        return;
      }
      // í´ë°±(currentTime)
      const t = video.currentTime || 0;
      if (t === lastVideoTime) stillTicks++; else stillTicks = 0;
      lastVideoTime = t;
      if (stillTicks >= FREEZE_TICKS || !isStreamHealthy()){
        await forceHardRestart('í”„ë ˆì„ ì •ì§€/ìŠ¤íŠ¸ë¦¼ ì´ìƒ');
      }
    }, HEARTBEAT_MS);
  }
  function stopWatchdog(){ if(watchdogTimer) clearInterval(watchdogTimer); watchdogTimer=null; }

  // ===== ìŠ¤íŠ¸ë¦¼ í—¬ìŠ¤ =====
  function isStreamHealthy(){
    const track = stream?.getVideoTracks?.()[0];
    return !!(track && track.readyState === 'live' && track.enabled !== false);
  }

  // ===== ê°•ì œ í•˜ë“œ ë¦¬ì…‹ =====
  async function forceHardRestart(reason){
    lastRestartAt = performance.now();
    setMsg((reason||'') + ' (í•˜ë“œ ë¦¬ì…‹ ì¤‘â€¦)');

    // 1) ìŠ¤ìº” ë£¨í”„ ë¬´íš¨í™”
    scanSessionId++;

    // 2) ë¯¸ëŸ¬/ì›Œì¹˜ë…/í”„ë ˆì„í‹±ì»¤ ì¤‘ë‹¨
    stopPhotoLive(); stopWatchdog(); stopFrameTicker();

    // 3) ìŠ¤íŠ¸ë¦¼ ì¢…ë£Œ
    try{ stream?.getTracks?.().forEach(t=>t.stop()); }catch(_){}
    stream=null; running=false;

    // 4) ë¹„ë””ì˜¤ ìš”ì†Œ ì¬ìƒì„± ë° ìˆ¨ê¹€
    video = recreateVideoElement();
    showPreview(false);

    // 5) ìƒíƒœ ì´ˆê¸°í™”
    lastVideoTime=0; stillTicks=0; lastFrameTS=0; accept={v:null,at:0};

    // 6) ì¬ê¸°ë™
    try{
      await startCamera();
      await ensureVisible();
      showPreview(true);
      // ìŠ¤ìº” ëª¨ë“œ ìë™ ë³µê·€
      MODE='scan';
      startQrBtn.textContent='QR ì¹´ë©”ë¼ OFF';
      scanSessionId++;
      startScanLoop(scanSessionId);
      setMsg('ì¹´ë©”ë¼ ë³µêµ¬ ì™„ë£Œ. QRì„ ë‹¤ì‹œ ë§ì¶°ì£¼ì„¸ìš”.');
    }catch(e){
      setMsg('ì¹´ë©”ë¼ í•˜ë“œ ë¦¬ì…‹ ì‹¤íŒ¨: '+(e.name||e));
      MODE='idle';
      startQrBtn.textContent='ğŸ¥ QR ì¹´ë©”ë¼ ON';
    }
  }

  // ===== ì¹´ë©”ë¼ =====
  async function startCamera(){
    // ìµœê·¼ ì„±ê³µ deviceId ìš°ì„ , ì‹¤íŒ¨ ì‹œ ì™„í™”
    let constraints = {
      video:{
        ...(lastGoodDeviceId ? { deviceId:{ exact:lastGoodDeviceId } } : { facingMode:{ideal:isMobile?'environment':'user'} }),
        width:{ideal:1920}, height:{ideal:1080},
        frameRate:{ideal:30, max:60},
        aspectRatio:{ideal:4/3},
        advanced:[ { focusMode:'continuous' }, { resizeMode:'none' } ]
      },
      audio:false
    };
    try{
      stream=await navigator.mediaDevices.getUserMedia(constraints);
    }catch(_){
      constraints = { video:{ facingMode:{ideal:isMobile?'environment':'user'} }, audio:false };
      stream=await navigator.mediaDevices.getUserMedia(constraints);
    }

    // ë¹„ë””ì˜¤ ìš”ì†Œ ì¬ë°°ì„ 
    video.srcObject=null; video.load(); video.srcObject=stream;

    // (ì§€ì› ì‹œ) ê¸°ë³¸ ì¤Œ ì†Œí­ ì ìš©
    try{
      const track=stream.getVideoTracks()[0];
      const caps=track.getCapabilities?.()||{};
      if('zoom' in caps){
        const target=Math.min(caps.max, Math.max(caps.min, 2.0));
        await track.applyConstraints({ advanced:[{ zoom: target }] });
      }
      lastGoodDeviceId = stream.getVideoTracks?.()[0]?.getSettings?.().deviceId || lastGoodDeviceId;
    }catch(_){}

    await new Promise(r=>{
      if(video.readyState>=HTMLMediaElement.HAVE_ENOUGH_DATA) return r();
      const ok=()=>r(); video.addEventListener('loadeddata',ok,{once:true}); video.addEventListener('canplay',ok,{once:true});
    });
    await video.play().catch(()=>{});
    running=true;
    startFrameTicker(video);
    startWatchdog();
  }
  function stopCamera(){
    try{ stream?.getTracks().forEach(t=>t.stop()); }catch(_){}
    stream=null; running=false;
    stopFrameTicker(); stopWatchdog();
    try{ video.pause(); }catch(_){}
    video.srcObject=null; video.load();
    showPreview(false);
    hidePhotoPanel();
  }

  // ===== ê³µìš© ìŠ¤ìº” ë£¨í”„(ì„¸ì…˜ ê¸°ë°˜) =====
  function startScanLoop(sessionId){
    let det=null, useDetector=false;
    try{
      if('BarcodeDetector' in window && typeof BarcodeDetector==='function'){
        det=new BarcodeDetector({formats:['qr_code']});
        useDetector=true;
      }
    }catch(_){ useDetector=false; }

    const cache={ c:document.createElement('canvas'), x:null };
    cache.x=cache.c.getContext('2d',{willReadFrequently:true});
    let frame=0;

    const step = async ()=>{
      if(sessionId!==scanSessionId) return;       // ì„¸ì…˜ ë§Œë£Œ
      if(MODE!=='scan' || !running) return;

      if(useDetector){
        try{
          const r=await det.detect(video);
          const val=r && r[0]?.rawValue;
          if(val && hasIdField(val) && canAccept(val)){
            try{ await onQrDetected(val); }catch(e){
              console.error('Detector path onQrDetected error', e);
              await forceHardRestart('QR ì²˜ë¦¬ ì˜ˆì™¸(Detector)');
              return;
            }
          }
        }catch(e){
          // Detector ë³µêµ¬ ì‹œë„ â†’ ì‹¤íŒ¨ ì‹œ jsQR í´ë°±
          try{ det=new BarcodeDetector({formats:['qr_code']}); }
          catch(_){ useDetector=false; }
        }
        requestAnimationFrame(step);
        return;
      }

      // jsQR ê²½ë¡œ
      if(video.readyState!==HTMLMediaElement.HAVE_ENOUGH_DATA){ return requestAnimationFrame(step); }
      if(frame++<8){ return requestAnimationFrame(step); }

      let qr=null;
      for(const w of TARGET_STEPS){ qr=tryDecode(video,{width:w,full:false,centerCrop:true,boost:true},cache); if(qr&&qr.data) break; }
      if(!qr){ for(const w of TARGET_STEPS){ qr=tryDecode(video,{width:w,full:false,centerCrop:true},cache); if(qr&&qr.data) break; } }
      if(!qr){ for(const w of TARGET_STEPS){ qr=tryDecode(video,{width:w,full:true},cache); if(qr&&qr.data) break; } }

      if(qr && qr.data && hasIdField(qr.data) && canAccept(qr.data)){
        try{ await onQrDetected(qr.data); }catch(e){
          console.error('jsQR path onQrDetected error', e);
          await forceHardRestart('QR ì²˜ë¦¬ ì˜ˆì™¸(jsQR)');
          return;
        }
      }
      requestAnimationFrame(step);
    };

    requestAnimationFrame(step);
  }

  // ===== QR ìŠ¤ìº” ì‹œì‘ =====
  let accept={v:null,at:0};
  function canAccept(v){ const now=performance.now(); if(v && accept.v===v && now-accept.at<2000) return false; accept={v,at:now}; return true; }

  async function startQrScan(){
    MODE='scan'; setMsg('QRì„ í™”ë©´ ì¤‘ì•™ì— í¬ê²Œ ë§ì¶°ì£¼ì„¸ìš”â€¦'); hidePhotoPanel();
    if(preview.parentNode!==previewHost) previewHost.appendChild(preview);

    if(!running){ await startCamera(); await ensureVisible(); } else { await ensureVisible(); }

    showPreview(true); photoLive.style.display='none'; overlay.style.display='none';
    accept={v:null,at:0};

    scanSessionId++;                 // ìƒˆ ìŠ¤ìº” ì„¸ì…˜
    startScanLoop(scanSessionId);
  }

  // ===== íŒŒì„œ =====
  function parseQR(text){
    const raw=String(text||'').trim();
    const out={id:'',name:'',loc:'',owner:'',raw};
    const parts = raw.split(/[;]+/).map(s=>s.trim()).filter(Boolean);
    for(const p of parts){
      const i=p.indexOf('=');
      if(i<0) continue;
      const key=p.slice(0,i).trim().toLowerCase();
      let val=p.slice(i+1).trim();
      val = safeKoreanDecode(val);
      if(key==='id') out.id=val;
      else if(key==='name') out.name=val;
      else if(key==='loc'||key==='location') out.loc=val;
      else if(key==='owner'||key==='user') out.owner=val;
    }
    return out;
  }

  // rawì—ì„œë„ id ì¶”ì¶œí•´ ë¹„êµ
  function extractIdFromRaw(raw){
    const txt=String(raw||'');
    const parts=txt.split(/[;]+/).map(s=>s.trim()).filter(Boolean);
    for(const p of parts){
      const i=p.indexOf('='); if(i<0) continue;
      const k=p.slice(0,i).trim().toLowerCase(); if(k!=='id') continue;
      let v=p.slice(i+1).trim();
      try{ v = safeKoreanDecode(v); }catch(_){}
      return v;
    }
    return '';
  }
  function hasSameId(id){
    const target=String(id||'').trim().toLowerCase(); if(!target) return false;
    return records.some(r=>{
      const rid=String(r.id||'').trim().toLowerCase();
      const rraw=String(extractIdFromRaw(r.raw)||'').trim().toLowerCase();
      return (rid && rid===target) || (rraw && rraw===target);
    });
  }

  // ===== ë Œë” =====
  function renderTable(o){
    const rows=[['ë¹„í’ˆë²ˆí˜¸','id','id'],['ë¹„í’ˆëª…','name','name'],['ìœ„ì¹˜','loc','loc'],['ì‚¬ìš©ì','owner','owner']];
    tbody.innerHTML='';
    rows.forEach(([label,key,cls])=>{
      const tr=document.createElement('tr');
      const th=document.createElement('th'); th.className='key'; th.innerHTML=`<span class="chip ${cls}">${label}</span>`;
      const td=document.createElement('td'); td.textContent=o[key]??'';
      tr.append(th,td); tbody.appendChild(tr);
    });
  }
  function renderChips(o){
    photoChips.innerHTML=`<span class="chip id">ë¹„í’ˆë²ˆí˜¸: ${esc(o.id)}</span>
    <span class="chip name">ë¹„í’ˆëª…: ${esc(o.name)}</span>
    <span class="chip loc">ìœ„ì¹˜: ${esc(o.loc)}</span>
    <span class="chip owner">ì‚¬ìš©ì: ${esc(o.owner)}</span>`;
  }

  // ===== QR ì²˜ë¦¬ =====
  async function onQrDetected(val){
    try{
      const parsed=parseQR(val);

      // ê¹¨ì§„ ë¬¸ì(ï¿½)ê°€ ë‹¤ëŸ‰ í¬í•¨ëœ ê²½ìš°, ì‚¬ìš©ì ì•ˆë‚´ í›„ ì¦‰ì‹œ í•˜ë“œ ë¦¬ì…‹ë¡œ íšŒë³µ
      const badness = (val.match(/\uFFFD/g)||[]).length;
      if(badness>=2){
        setMsg('ë¬¸ì ì¸ì½”ë”©ì´ ë¹„ì •ìƒì¸ QRì„ ê°ì§€í–ˆìŠµë‹ˆë‹¤. ì¹´ë©”ë¼ë¥¼ ë³µêµ¬í•©ë‹ˆë‹¤â€¦');
        await forceHardRestart('ë¹„ì •ìƒ ì¸ì½”ë”© QR ê°ì§€');
        return;
      }

      if(!parsed.id){
        setMsg('ì¸ì‹ëœ QRì— ë¹„í’ˆë²ˆí˜¸(id=)ê°€ ì—†ìŠµë‹ˆë‹¤. ì˜¬ë°”ë¥¸ QRì„ ë‹¤ì‹œ ìŠ¤ìº”í•˜ì„¸ìš”.');
        MODE='scan'; showPreview(true); photoLive.style.display='none'; hidePhotoPanel();
        return;
      }

      renderTable(parsed);

      if(parsed.id && hasSameId(parsed.id)){
        const ok=confirm('ìµœê·¼ ì €ì¥ ëª©ë¡ì— ê°™ì€ ë¹„í’ˆë²ˆí˜¸ê°€ ìˆìŠµë‹ˆë‹¤.\nê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
        if(!ok){
          stopPhotoLive(); hidePhotoPanel(); stopCamera(); MODE='idle';
          startQrBtn.textContent='ğŸ¥ QR ì¹´ë©”ë¼ ON';
          setMsg('ì·¨ì†Œë¨: ì¹´ë©”ë¼ë¥¼ ê»ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œì‘í•˜ë ¤ë©´ [QR ì¹´ë©”ë¼ ON]ì„ ëˆ„ë¥´ì„¸ìš”.');
          accept={v:null,at:0};
          return;
        }
      }

      if(!requirePhotoChk.checked){
        stopCamera(); MODE='idle';
        upsert({...parsed, imgDataUrl:null});
        hidePhotoPanel();
        setMsg('ì‚¬ì§„ ì—†ì´ ì €ì¥í–ˆìŠµë‹ˆë‹¤.');
        startQrBtn.textContent='ğŸ¥ QR ì¹´ë©”ë¼ ON';
        return;
      }

      pendingParsed=parsed;
      MODE='photo';
      renderChips(parsed);
      photoStep.style.display='block';
      showPreview(false);
      photoLive.style.display='block';
      await ensureVisible();
      startPhotoLive();
      setMsg('ë¹„í’ˆì„ í”„ë ˆì„ì— ë§ì¶° [ë¹„í’ˆ ì‚¬ì§„ ì´¬ì˜]ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
      smoothScrollTo(photoStep,-8);
      photoStep.classList.add('pulse');
      setTimeout(()=>photoStep.classList.remove('pulse'),2500);
    }catch(e){
      console.error(e);
      setMsg('QR íŒŒì‹±/ë¬¸ì ì¸ì½”ë”© ì˜¤ë¥˜ â†’ ë³µêµ¬ ì¤‘â€¦');
      await forceHardRestart('QR íŒŒì‹± ì˜ˆì™¸');
    }
  }

  // ===== ìº¡ì²˜ =====
  async function capture(videoEl, maxW=960){
    const vw=videoEl.videoWidth||640, vh=videoEl.videoHeight||480, aspect=4/3;
    const srcAR=vw/vh;
    let sx=0, sy=0, sw=vw, sh=vh;
    if(srcAR>aspect){ sw=Math.round(vh*aspect); sx=Math.round((vw-sw)/2); }
    else if(srcAR<aspect){ sh=Math.round(vw/aspect); sy=Math.round((vh-sh)/2); }
    const outW=Math.min(maxW, sw), outH=Math.round(outW/aspect);
    const c=document.createElement('canvas'); c.width=outW; c.height=outH;
    c.getContext('2d',{willReadFrequently:true}).drawImage(videoEl, sx, sy, sw, sh, 0, 0, outW, outH);
    return c.toDataURL('image/jpeg', 0.6);
  }

  // ===== ë²„íŠ¼ =====
  startQrBtn.onclick=async()=>{
    if(running){
       // OFF ë™ì‘: ì¬ê°€ë™(ë¦¬ì…‹) ë§ê³  'ê·¸ëƒ¥ ë„ê¸°'
     hidePhotoPanel();
     stopCamera();
     MODE = 'idle';
     startQrBtn.textContent = 'ğŸ¥ QR ì¹´ë©”ë¼ ON';
     setMsg('ì¹´ë©”ë¼ë¥¼ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œì‘í•˜ë ¤ë©´ [QR ì¹´ë©”ë¼ ON]ì„ ëˆ„ë¥´ì„¸ìš”.');
     accept = { v: null, at: 0 };
     return;
    }
    try{
      await startQrScan(); startQrBtn.textContent='QR ì¹´ë©”ë¼ OFF';
      if(isMobile) smoothScrollTo(previewHost,-10);
    }catch(e){
      setMsg('ì¹´ë©”ë¼ ì˜¤ë¥˜: '+(e.name||e)); hidePhotoPanel(); stopCamera(); MODE='idle';
      startQrBtn.textContent='ğŸ¥ QR ì¹´ë©”ë¼ ON';
    }
  };

  shotBtn.onclick=async()=>{
    if(MODE!=='photo' || !pendingParsed) return;
    const data={...pendingParsed};
    const img=await capture(video,800).catch(()=>null);
    stopPhotoLive(); photoLive.style.display='none'; stopCamera(); MODE='idle';
    upsert({...data, imgDataUrl: img});
    pendingParsed=null; photoStep.style.display='none';
    setMsg('ì €ì¥ ì™„ë£Œ'); startQrBtn.textContent='ğŸ¥ QR ì¹´ë©”ë¼ ON';
    scrollToTop();
  };

  skipBtn.onclick=async()=>{
    if(MODE!=='photo' || !pendingParsed) return;
    const data={...pendingParsed};
    stopPhotoLive(); photoLive.style.display='none'; stopCamera(); MODE='idle';
    upsert({...data, imgDataUrl:null});
    pendingParsed=null; photoStep.style.display='none';
    setMsg('ì‚¬ì§„ ì—†ì´ ì €ì¥í–ˆìŠµë‹ˆë‹¤.'); startQrBtn.textContent='ğŸ¥ QR ì¹´ë©”ë¼ ON';
    scrollToTop();
  };

  clearBtn.onclick=()=>{
    if(!confirm('ì €ì¥ëœ ëª¨ë“  ë ˆì½”ë“œë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;
    records=[]; save(); renderList(); tbody.innerHTML=''; setMsg('ì´ˆê¸°í™” ì™„ë£Œ');
  };

  exportXlsxBtn.onclick=async()=>{
    if(records.length===0){ setMsg('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
    const wb=new ExcelJS.Workbook(); const ws=wb.addWorksheet('QR Scans');
    ws.columns=[{header:'ìŠ¤ìº”ì‹œê°', width:22},{header:'ë¹„í’ˆë²ˆí˜¸', width:18},{header:'ë¹„í’ˆëª…', width:28},{header:'ìœ„ì¹˜', width:18},{header:'ì‚¬ìš©ì', width:18},{header:'ë¹„í’ˆì‚¬ì§„', width:28}];
    ws.getRow(1).height=22; let rowIdx=2;
    for(const r of records){
      ws.addRow([r.scanned_at_kst||'', r.id||'', r.name||'', r.loc||'', r.owner||'', '']);
      ws.getRow(rowIdx).height=95;
      if(r.imgDataUrl){
        const imgId=wb.addImage({base64:r.imgDataUrl.split(',')[1], extension:'jpeg'});
        ws.addImage(imgId, { tl:{ col:5, row:rowIdx-1 }, ext:{ width:180, height:120 } });
      }
      rowIdx++;
    }
    const buf=await wb.xlsx.writeBuffer();
    saveAs(new Blob([buf],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}), `qr_scans_${new Date().toISOString().slice(0,10)}.xlsx`);
  };

  // ===== ê°€ì‹œì„± ì „í™˜ =====
  document.addEventListener('visibilitychange', ()=>{
    if (document.visibilityState === 'hidden') {
      hidePhotoPanel();
      stopCamera();
      MODE = 'idle';
      startQrBtn.textContent = 'ğŸ¥ QR ì¹´ë©”ë¼ ON';
      setMsg('ë°±ê·¸ë¼ìš´ë“œë¡œ ì´ë™í•˜ì—¬ ì¹´ë©”ë¼ë¥¼ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤.');
    }
  });

  window.addEventListener('beforeunload', ()=>{
    try{ stream?.getTracks().forEach(t=>t.stop()); }catch(_){}
  });

})();
</script>

</body>
</html>

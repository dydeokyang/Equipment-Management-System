---
---
<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>디와이덕양 비품관리</title>

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>

<script>
(function () {
  const APP_VERSION = '{{ site.time | date: "%Y%m%d%H%M%S" }}';
  const url = new URL(location.href);
  if (url.searchParams.get('v') !== APP_VERSION) {
    url.searchParams.set('v', APP_VERSION);
    location.replace(url.toString());
  }
})();
</script>

<style>
  :root{
    --bg:#fff; --fg:#16181b; --muted:#667085; --border:#e6e8eb;
    --shadow:0 4px 14px rgba(0,0,0,.08);
    --chip-id:#eef2ff;     --chip-id-text:#1d4ed8;
    --chip-name:#ecfdf5;   --chip-name-text:#065f46;
    --chip-loc:#fff7ed;    --chip-loc-text:#9a3412;
    --chip-owner:#fef2f2;  --chip-owner-text:#b91c1c;
  }
  body{font-family:system-ui,malgun gothic,apple sd gothic neo,arial;background:var(--bg);color:var(--fg);
       max-width:860px;margin:28px auto;padding:0 16px}
  h1{font-size:22px;margin:14px 0}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:12px 0}
  button{font-size:16px;padding:9px 14px;border:1px solid var(--border);border-radius:8px;background:#fff;cursor:pointer}
  button:hover{border-color:#c9ced6}
  #preview{position:relative; display:inline-block}
  #video{width:100%;max-width:520px;display:none;border:1px solid var(--border);border-radius:12px;margin:10px 0;box-shadow:var(--shadow)}
  #overlay{display:none; position:absolute; inset:0; width:100%; max-width:520px; pointer-events:none}
  .card{background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:14px;margin:14px 0}
  .subtitle{color:var(--muted);font-size:13px;margin-top:-6px;margin-bottom:10px}
  table{border-collapse:separate;border-spacing:0;width:100%}
  th,td{padding:12px 12px;border-bottom:1px solid var(--border);text-align:left;word-break:break-all}
  tbody tr:nth-child(even){background:#fcfdff}
  tbody tr:last-child td, tbody tr:last-child th{border-bottom:0}
  #msg{color:#b00;margin:6px 2px}
  .count{margin-left:auto;color:#333;font-size:14px}
  .mono{font-family:ui-monospace,SFMono-Regular,Consolas,monospace}

  th.key{font-weight:600;border:0;background:transparent;padding:6px 0}
  .chip{display:inline-block;padding:4px 10px;border-radius:999px;font-size:13px}
  .chip.id   {background:var(--chip-id);   color:var(--chip-id-text)}
  .chip.name {background:var(--chip-name); color:var(--chip-name-text)}
  .chip.loc  {background:var(--chip-loc);  color:var(--chip-loc-text)}
  .chip.owner{background:var(--chip-owner);color:var(--chip-owner-text)}

  .list{display:grid;grid-template-columns:1fr;gap:12px}
  @media (min-width:680px){ .list{grid-template-columns:1fr 1fr} }
  .item{border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff;box-shadow:var(--shadow)}
  .item .head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .item .time{font-size:13px;color:#334155;background:#f1f5f9;border-radius:6px;padding:4px 8px}
  .badges{display:flex;flex-wrap:wrap;gap:6px}
  .badge{font-size:12px;border-radius:999px;padding:3px 8px}
  .badge.id   {background:var(--chip-id);   color:var(--chip-id-text)}
  .badge.name {background:var(--chip-name); color:var(--chip-name-text)}
  .badge.loc  {background:var(--chip-loc);  color:var(--chip-loc-text)}
  .badge.owner{background:var(--chip-owner);color:var(--chip-owner-text)}
</style>
</head>
<body>
<h1>QR 스캐너</h1>

<div class="row">
  <button id="startBtn">카메라 시작</button>
  <button id="exportBtn">CSV 내보내기</button>
  <button id="clearBtn"  title="저장된 모든 레코드를 삭제합니다.">초기화</button>
  <span class="count" id="count">저장 0건</span>
</div>

<div id="preview">
  <video id="video" playsinline muted></video>
  <canvas id="overlay"></canvas>
</div>
<p id="msg"></p>

<div class="card">
  <h2>비품정보</h2>
  <div class="subtitle">스캔 즉시 아래 표에 표시됩니다.</div>
  <table id="tbl"><tbody></tbody></table>
</div>

<div class="card">
  <h2>최근 저장 목록 <span class="mono" style="font-size:12px;color:#475569">(KST 기준)</span></h2>
  <div class="subtitle">같은 항목을 다시 스캔해도 중복 저장하지 않고, 시간만 갱신합니다.</div>
  <div id="list" class="list"></div>
</div>

<!-- jsQR (minified, 로컬 고정 버전 사용) -->
<script src="libs/jsQR.js?v={{ site.time | date: '%Y%m%d%H%M%S' }}"></script>

<script>
(() => {
  // ===== 설정 노브(아이폰 인식력 우선) =====
  const DEBUG = true;      // 상태 텍스트/박스 표시 (테스트 끝나면 false로)
  const TARGET = 720;      // 다운스케일 해상도(선명도↑). 640~800에서 조절
  const WARMUP_FRAMES = 6; // 초점/노출 안정까지 스킵
  const STACK_N = 3;       // 디플리커 프레임 수(모니터 QR에 유리)
  const FRAME_GAP = 60;    // 디코드 주기(ms). 50~80 추천

  const video   = document.getElementById('video');
  const overlay = document.getElementById('overlay');
  const ox      = overlay.getContext('2d');
  const msg     = document.getElementById('msg');
  const tbody   = document.querySelector('#tbl tbody');
  const listEl  = document.getElementById('list');
  const countEl = document.getElementById('count');

  let stream = null, running = false;

  // iOS 감지 (iPhone/iPad WebKit)
  const isIOS = (() => {
    const ua = navigator.userAgent || '';
    const iOSDevice = /iP(hone|ad|od)/.test(ua);
    const webkit = /WebKit/.test(ua);
    const isCriOS = /CriOS/.test(ua);
    return (iOSDevice && webkit) || isCriOS;
  })();

  // 저장 -----------------------------------------------------------------
  let records = loadRecords(); renderList();
  function loadRecords(){ try{ return JSON.parse(localStorage.getItem('qr_records')||'[]'); } catch(e){ return []; } }
  function saveRecords(){ localStorage.setItem('qr_records', JSON.stringify(records)); }
  function setMsg(t){ msg.textContent = t || ''; }

  // 시간(KST)
  function fmtKST(d){
    const p = new Intl.DateTimeFormat('ko-KR',{ timeZone:'Asia/Seoul', year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false }).formatToParts(d);
    const g = t => p.find(x=>x.type===t)?.value || '';
    return `${g('year')}-${g('month')}-${g('day')} ${g('hour')}:${g('minute')}:${g('second')}`;
  }
  function nowKST(){ return fmtKST(new Date()); }

  // 중복 키
  function dedupeKey(o){ const id=(o.id??'').trim(); return id ? 'ID:'+id.toLowerCase() : 'RAW:'+String(o.raw??''); }

  // QR 파서
  function parseQR(text){
    let obj = {};
    try { const j = JSON.parse(text); if (j && typeof j==='object') obj = j; }
    catch {
      if (text.includes('=')) {
        text.split(';').forEach(pair=>{
          const pos = pair.indexOf('='); if (pos<0) return;
          const k = pair.slice(0,pos).trim(); const v = pair.slice(pos+1).trim();
          if (k) obj[k] = v;
        });
      } else if (text.includes(':')) {
        const parts = text.split(':');
        if (parts.length >= 4) { obj.id=parts[0].trim(); obj.name=parts[1].trim(); obj.loc=parts[2].trim(); obj.owner=parts[3].trim(); }
      }
    }
    return { id:obj.id??'', name:obj.name??'', loc:obj.loc??'', owner:obj.owner??'', raw:text };
  }

  const FIELD_ORDER = [
    {key:'id',    label:'비품번호', class:'id'},
    {key:'name',  label:'비품명',   class:'name'},
    {key:'loc',   label:'위치',     class:'loc'},
    {key:'owner', label:'사용자',   class:'owner'},
  ];

  function renderTable(o){
    tbody.innerHTML=''; 
    FIELD_ORDER.forEach(({key,label,class:cls})=>{
      const tr=document.createElement('tr');
      const th=document.createElement('th'); th.className='key'; th.innerHTML=`<span class="chip ${cls}">${label}</span>`;
      const td=document.createElement('td'); td.textContent=o[key]??'';
      tr.append(th,td); tbody.appendChild(tr);
    });
  }

  function upsertRecord(o){
    const key = dedupeKey(o);
    const kst = nowKST();
    const idx = records.findIndex(r => r._key===key);
    if (idx>=0){
      const updated={...records[idx], id:o.id,name:o.name,loc:o.loc,owner:o.owner,raw:o.raw, scanned_at_kst:kst};
      records.splice(idx,1); records.push(updated);
      setMsg('이미 저장된 항목입니다. 시간만 갱신했어요.');
    } else {
      records.push({_key:key, id:o.id,name:o.name,loc:o.loc,owner:o.owner, raw:o.raw, scanned_at_kst:kst});
      setMsg('');
    }
    saveRecords(); renderList();
  }

  function renderList(){
    listEl.innerHTML=''; countEl.textContent=`저장 ${records.length}건`;
    records.slice().reverse().forEach(r=>{
      const card=document.createElement('div'); card.className='item';
      card.innerHTML = `
        <div class="head"><div class="time mono">${r.scanned_at_kst}</div></div>
        <div class="badges">
          <span class="badge id">비품번호: ${esc(r.id)}</span>
          <span class="badge name">비품명: ${esc(r.name)}</span>
          <span class="badge loc">위치: ${esc(r.loc)}</span>
          <span class="badge owner">사용자: ${esc(r.owner)}</span>
        </div>`;
      listEl.appendChild(card);
    });
  }

  function esc(s){ return String(s??'').replace(/[&<>"]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m])); }

  function stop(){
    running=false;
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    video.srcObject=null;
    video.style.display='none';
    overlay.style.display='none';
  }

  function expect(cond, message){
    if(!cond){ setMsg(message); throw new Error(message); }
  }

  // 카메라 시작 -----------------------------------------------------------
  async function start(){
    // 즉시 실패 원인 노출
    expect(!!window.jsQR, 'jsQR가 로드되지 않았습니다. /libs/jsQR.js 경로(배포 여부)를 확인하세요.');
    expect(location.protocol==='https:' || location.hostname==='localhost', 'HTTPS 또는 localhost에서만 동작합니다.');
    expect(!!navigator.mediaDevices?.getUserMedia, '이 브라우저는 카메라 API를 지원하지 않습니다.');

    try{
      stop(); // 이전 세션 정리

      // iOS 자동재생/인라인 재생 안전장치
      video.setAttribute('playsinline','');
      video.setAttribute('muted','');
      video.muted = true;

      stream = await navigator.mediaDevices.getUserMedia({
        video:{ facingMode:{ideal:'environment'}, width:{ideal:1280}, height:{ideal:720} },
        audio:false
      });
      video.srcObject = stream;

      // 워밍업: 프레임 준비까지 대기
      if (video.readyState < HTMLMediaElement.HAVE_ENOUGH_DATA) {
        await new Promise(resolve => {
          const onReady = ()=>resolve();
          video.addEventListener('loadeddata', onReady, { once:true });
          video.addEventListener('canplay',    onReady, { once:true });
        });
      }
      await video.play();

      // 오버레이 초기화
      overlay.width  = video.videoWidth  || 640;
      overlay.height = video.videoHeight || 480;
      overlay.style.display = DEBUG ? 'block' : 'none';

      video.style.display='block';
      running = true;

      if (DEBUG) setMsg(`카메라 시작: ${overlay.width}x${overlay.height} / iOS:${isIOS?'Y':'N'}`);
      else setMsg('QR을 화면 중앙에 크게 맞춰주세요…');

      // iOS: 네이티브 없음 → jsQR 폴백만 사용
      if (isIOS) { jsqrFallback(); return; }

      // AND/데스크톱: 네이티브 + jsQR 레이스 (먼저 잡는 쪽이 승리)
      let resolved = false;
      const win = (val)=>{
        if (resolved) return true;
        if (val) {
          resolved = true;
          stop();
          const parsed = parseQR(val);
          renderTable(parsed);
          upsertRecord(parsed);
          return true;
        }
        return false;
      };

      // A) BarcodeDetector 루프 (grabFrame은 기기별 이슈 → detect(video)만)
      const runDetector = async ()=>{
        if(!('BarcodeDetector' in window)) return;
        const detector = new BarcodeDetector({ formats:['qr_code'] });
        const loop = async ()=>{
          if(!running || resolved) return;
          try{
            const found = await detector.detect(video);
            const val = found && found[0]?.rawValue;
            if (win(val)) return;
          }catch(_) { /* 계속 */ }
          requestAnimationFrame(loop);
        };
        loop();
      };

      // B) jsQR 폴백 루프 (소폭 딜레이 후 시작 → CPU 분배)
      const runJsQR = ()=>{
        setTimeout(()=>{ if(!resolved && running) jsqrFallback(()=>resolved); }, 400);
      };

      runDetector();
      runJsQR();

      // (선택) 카메라 힌트: 일부 기기에서 초점/줌 도움(무시될 수 있음)
      try {
        const track = stream?.getVideoTracks?.()[0];
        const caps  = track?.getCapabilities?.() || {};
        const cons  = { advanced: [] };
        if (caps?.focusMode?.length) cons.advanced.push({ focusMode: 'continuous' });
        if (caps?.zoom) {
          const mid = (caps.zoom.min + caps.zoom.max) / 2;
          cons.advanced.push({ zoom: Math.min(Math.max(mid, caps.zoom.min), caps.zoom.max) });
        }
        if (cons.advanced.length) await track.applyConstraints(cons);
      } catch(_) {}
    }catch(e){
      const map={NotAllowedError:'카메라 권한이 거부되었습니다. 브라우저/사이트 설정에서 허용해주세요.',
                 NotFoundError:'카메라 장치를 찾을 수 없습니다.',
                 NotReadableError:'다른 앱이 카메라 사용 중입니다.',
                 OverconstrainedError:'카메라 조건을 만족하지 못했습니다.',
                 SecurityError:'보안 정책으로 차단되었습니다.'};
      setMsg(map[e.name]||`카메라 오류: ${e.name||e}`);
    }
  }

  // jsQR 폴백(중앙 크롭 + 디플리커 + 대비 스트레치)
  function jsqrFallback(isResolved){
    const c = document.createElement('canvas');
    const x = c.getContext('2d', { willReadFrequently: true });
    x.imageSmoothingEnabled = false;

    const target   = TARGET;
    const minGapMs = FRAME_GAP;
    let frame = 0, last = 0, cancel = false;
    const stack = []; // Uint8ClampedArray 회색 프레임들

    const drawDebug = (text, corners)=>{
      if(!DEBUG) return;
      ox.clearRect(0,0,overlay.width,overlay.height);
      ox.fillStyle='rgba(0,0,0,.55)'; ox.fillRect(6,6, overlay.width*0.7, 28);
      ox.fillStyle='#fff'; ox.font='16px ui-monospace,monospace'; ox.fillText(text, 14, 26);
      if(corners){
        ox.strokeStyle='lime'; ox.lineWidth=3; ox.beginPath();
        ox.moveTo(corners.topLeft.x, corners.topLeft.y);
        ox.lineTo(corners.topRight.x, corners.topRight.y);
        ox.lineTo(corners.bottomRight.x, corners.bottomRight.y);
        ox.lineTo(corners.bottomLeft.x, corners.bottomLeft.y);
        ox.closePath(); ox.stroke();
      }
    };

    const runOnce = ()=>{
      if(!running || cancel) return;
      if(video.readyState !== video.HAVE_ENOUGH_DATA) return;

      const vw = video.videoWidth  || 640;
      const vh = video.videoHeight || 480;
      const side = Math.min(vw, vh);
      const sx = (vw - side) >> 1;
      const sy = (vh - side) >> 1;

      c.width = target; c.height = target;
      x.drawImage(video, sx, sy, side, side, 0, 0, target, target);

      if (frame++ < WARMUP_FRAMES) { drawDebug('warming up…', null); return; }

      // 그레이 변환
      const img = x.getImageData(0, 0, target, target);
      const buf = new Uint8ClampedArray(img.data.length);
      for (let i=0;i<img.data.length;i+=4){
        const r=img.data[i], g=img.data[i+1], b=img.data[i+2];
        const y = (r*0.2126 + g*0.7152 + b*0.0722)|0;
        buf[i]=buf[i+1]=buf[i+2]=y; buf[i+3]=255;
      }
      stack.push(buf);
      if (stack.length > STACK_N) stack.shift();

      // 디플리커(최솟값 합성)
      if (stack.length === STACK_N){
        for (let i=0;i<img.data.length;i+=4){
          let m = 255;
          for (let k=0;k<STACK_N;k++) if (stack[k][i] < m) m = stack[k][i];
          img.data[i]=img.data[i+1]=img.data[i+2]=m;
        }
      } else {
        for (let i=0;i<img.data.length;i+=4){
          img.data[i]=img.data[i+1]=img.data[i+2]=buf[i];
        }
      }

      // 약한 대비 스트레치
      let lo=255, hi=0;
      for (let i=0;i<img.data.length;i+=16){ const v=img.data[i]; if(v<lo)lo=v; if(v>hi)hi=v; }
      const span=Math.max(40, hi-lo), a=255/span, b0=-a*lo;
      for (let i=0;i<img.data.length;i+=4){
        let v = img.data[i]; v = a*v + b0; if(v<0)v=0; if(v>255)v=255;
        img.data[i]=img.data[i+1]=img.data[i+2]=v;
      }

      const t0 = performance.now();
      const qr = jsQR(img.data, target, target, { inversionAttempts: 'attemptBoth' });
      const t1 = performance.now();
      const fps = Math.round(1000 / Math.max(1, (t1 - last || minGapMs))); last = t1;

      if (qr && qr.data){
        if (typeof isResolved === 'function' && isResolved()) return; // 레이스 이미 성공
        // 코너 역매핑(원본 좌표로)
        const scale = side / target, offX = sx, offY = sy;
        const map = p => ({ x: p.x*scale + offX, y: p.y*scale + offY });
        const corners = {
          topLeft:     map(qr.location.topLeftCorner),
          topRight:    map(qr.location.topRightCorner),
          bottomRight: map(qr.location.bottomRightCorner),
          bottomLeft:  map(qr.location.bottomLeftCorner),
        };
        drawDebug(`decoded fps:${fps}`, corners);

        stop();
        const parsed=parseQR(qr.data); renderTable(parsed); upsertRecord(parsed); setMsg('');
      } else {
        drawDebug(`scanning… fps:${fps}`, null);
      }
    };

    const rVFC = video.requestVideoFrameCallback?.bind(video);
    if (rVFC) {
      const onFrame = (now)=>{ if(!running || cancel) return; if(now - last >= minGapMs){ runOnce(); } rVFC(onFrame); };
      rVFC(onFrame);
    } else {
      (function loop(){ if(!running || cancel) return; const now=performance.now(); if(now - last >= minGapMs){ runOnce(); } requestAnimationFrame(loop); })();
    }

    const track = stream?.getVideoTracks?.()[0];
    track && track.addEventListener?.('ended', ()=>{ cancel = true; });
  }

  // CSV
  function exportCSV(){
    if(records.length===0){ setMsg('내보낼 데이터가 없습니다.'); return; }
    const header=['스캔시각(KST)','비품번호','비품명','위치','사용자'];
    const rows = records.map(r=>[ r.scanned_at_kst, r.id, r.name, r.loc, r.owner ]);
    const escCSV=v=>`"${String(v??'').replace(/"/g,'""')}"`;
    const lines=[header.map(escCSV).join(','), ...rows.map(row=>row.map(escCSV).join(','))].join('\r\n');
    const blob=new Blob(["\ufeff"+lines],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a');
    a.href=URL.createObjectURL(blob); a.download='qr_scans_'+new Date().toISOString().slice(0,10)+'.csv'; a.click();
  }

  // 초기화
  function clearAll(){
    if(!confirm('저장된 모든 레코드를 삭제할까요?')) return;
    records=[]; saveRecords(); renderList();
    tbody.innerHTML = ''; // 비품정보 표 비움
    setMsg('초기화 완료');
    stop(); // 카메라도 정지
  }

  // 페이지 숨김 시 정지
  document.addEventListener('visibilitychange', ()=>{ if(document.hidden){ stop(); } });

  // 버튼
  document.getElementById('startBtn').onclick = ()=> start();
  document.getElementById('exportBtn').onclick= exportCSV;
  document.getElementById('clearBtn').onclick = clearAll;
})();
</script>
</body>
</html>




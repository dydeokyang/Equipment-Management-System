---
---
<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>QR 스캐너 (중복방지 + CSV + KST시간 + 깔끔한표)</title>

<!-- 캐시 약화 메타 -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>

<!-- 자동 버전 쿼리(캐시 버스터): GitHub Pages(Liquid)로 자동 갱신 -->
<script>
(function () {
  const APP_VERSION = '{{ site.time | date: "%Y%m%d%H%M%S" }}'; // 커밋마다 자동으로 새 값
  const url = new URL(location.href);
  if (url.searchParams.get('v') !== APP_VERSION) {
    url.searchParams.set('v', APP_VERSION);
    location.replace(url.toString()); // 한 번만 새로고침
  }
})();
</script>

<style>
  :root{
    --bg:#fff; --fg:#181a1b; --muted:#666; --border:#e6e8eb;
    --accent:#2f6feb; --thead:#f8fafc; --shadow:0 4px 14px rgba(0,0,0,.08);
  }
  body{font-family:system-ui,malgun gothic,apple sd gothic neo,arial;background:var(--bg);color:var(--fg);
       max-width:840px;margin:28px auto;padding:0 16px}
  h1{font-size:22px;margin:14px 0}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:12px 0}
  button{font-size:16px;padding:9px 14px;border:1px solid var(--border);border-radius:8px;background:#fff;cursor:pointer}
  button:hover{border-color:#c9ced6}
  #video{width:100%;max-width:520px;display:none;border:1px solid var(--border);border-radius:12px;margin:10px 0;box-shadow:var(--shadow)}
  .card{background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:14px;margin:14px 0}
  .subtitle{color:var(--muted);font-size:13px;margin-top:-6px;margin-bottom:10px}
  table{border-collapse:separate;border-spacing:0;width:100%}
  th,td{padding:12px 12px;border-bottom:1px solid var(--border);text-align:left;word-break:break-all}
  thead th{background:var(--thead);font-weight:600}
  tbody tr:nth-child(even){background:#fcfdff}
  tbody tr:first-child td, tbody tr:first-child th{border-top-left-radius:8px;border-top-right-radius:8px}
  tbody tr:last-child td, tbody tr:last-child th{border-bottom-left-radius:8px;border-bottom-right-radius:8px;border-bottom:0}
  #msg{color:#b00;margin:6px 2px}
  .count{margin-left:auto;color:#333;font-size:14px}
  ul{padding-left:18px;margin:8px 0}
  .mono{font-family:ui-monospace,SFMono-Regular,Consolas,monospace}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#334155;font-size:12px;margin-left:6px}
</style>
</head>
<body>
<h1>QR 스캐너</h1>

<div class="row">
  <button id="startBtn">카메라 시작</button>
  <button id="exportBtn">CSV 내보내기</button>
  <button id="clearBtn" title="저장된 모든 레코드를 삭제합니다.">초기화</button>
  <span class="count" id="count">저장 0건</span>
</div>

<video id="video" playsinline muted></video>
<p id="msg"></p>

<div class="card">
  <h2>비품정보</h2>
  <div class="subtitle">스캔 즉시 아래 표에 표시됩니다.</div>
  <table id="tbl">
    <tbody></tbody>
  </table>
</div>

<div class="card">
  <h2>최근 저장 목록 <span class="pill mono">KST 기준</span></h2>
  <div class="subtitle">같은 항목을 다시 스캔해도 중복 저장되지 않고, 시간만 갱신됩니다.</div>
  <ul id="list"></ul>
</div>

<!-- jsQR 폴백용 -->
<script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
<script>
(() => {
  const video  = document.getElementById('video');
  const msg    = document.getElementById('msg');
  const tbody  = document.querySelector('#tbl tbody');
  const listEl = document.getElementById('list');
  const countEl= document.getElementById('count');

  let stream = null, running = false;

  // 저장 데이터 로드/저장
  let records = loadRecords();
  renderList();

  function loadRecords(){
    try{ return JSON.parse(localStorage.getItem('qr_records')||'[]'); }
    catch(e){ return []; }
  }
  function saveRecords(){ localStorage.setItem('qr_records', JSON.stringify(records)); }
  function setMsg(t){ msg.textContent = t || ''; }

  // === 시간 유틸 ===
  // (1) 서울시간(KST, Asia/Seoul) 보기 좋은 포맷: YYYY-MM-DD HH:mm:ss
  function fmtKST(d){
    const parts = new Intl.DateTimeFormat('ko-KR',{
      timeZone:'Asia/Seoul', year:'numeric', month:'2-digit', day:'2-digit',
      hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false
    }).formatToParts(d);
    const get = t => parts.find(p=>p.type===t)?.value || '';
    return `${get('year')}-${get('month')}-${get('day')} ${get('hour')}:${get('minute')}:${get('second')}`;
  }
  // (2) 현재 시각을 KST/UTC 모두 반환 (디바이스 시계 기준)
  function nowTimes(){
    const now = new Date();
    return { kst: fmtKST(now), utc: now.toISOString() };
  }

  // 중복 판별용 키: id가 있으면 id, 없으면 raw
  function dedupeKey(o){
    const id = (o.id ?? '').trim();
    if (id) return 'ID:' + id.toLowerCase();
    return 'RAW:' + String(o.raw ?? '');
  }

  // QR 텍스트 파싱 → {id,name,loc,owner, raw}
  function parseQR(text){
    let obj = {};
    // 1) JSON 시도
    try {
      const j = JSON.parse(text);
      if (j && typeof j === 'object') obj = j;
    } catch(e){
      // 2) key=value;key2=value2
      if (text.includes('=')) {
        text.split(';').forEach(p=>{
          const [k, ...rest] = p.split('=');
          if(!k) return;
          const v = rest.join('=');
          obj[k.trim()] = (v ?? '').trim();
        });
      } else if (text.includes(':')) {
        // 3) 콜론 4분절(id:name:loc:owner) 임시 대응
        const parts = text.split(':');
        if (parts.length >= 4) {
          obj.id    = parts[0].trim();
          obj.name  = parts[1].trim();
          obj.loc   = parts[2].trim();
          obj.owner = parts[3].trim();
        }
      }
    }
    return {
      id   : obj.id    ?? '',
      name : obj.name  ?? '',
      loc  : obj.loc   ?? '',
      owner: obj.owner ?? '',
      raw  : text
    };
  }

  function renderTable(o){
    tbody.innerHTML = '';
    const rows = [
      ['id', o.id],
      ['name', o.name],
      ['loc', o.loc],
      ['owner', o.owner]
    ];
    rows.forEach(([k,v])=>{
      const tr=document.createElement('tr');
      const th=document.createElement('th'); th.textContent=k;
      const td=document.createElement('td'); td.textContent=v;
      tr.append(th,td); tbody.appendChild(tr);
    });
  }

  // 중복 방지 업서트: 같은 dedupeKey면 추가하지 않고 시간 갱신 + 최신으로 이동
  function upsertRecord(o){
    const key = dedupeKey(o);
    const t   = nowTimes(); // ★ 디바이스 시간 사용 (kst/utc 저장)
    const idx = records.findIndex(r => (r._key === key));
    if (idx >= 0) {
      const updated = {
        ...records[idx],
        id:o.id, name:o.name, loc:o.loc, owner:o.owner, raw:o.raw,
        scanned_at_kst: t.kst, scanned_at_utc: t.utc
      };
      records.splice(idx, 1);
      records.push(updated);
      setMsg('이미 저장된 항목입니다. 시간만 갱신했어요.');
    } else {
      records.push({
        _key:key, id:o.id, name:o.name, loc:o.loc, owner:o.owner,
        raw:o.raw, scanned_at_kst: t.kst, scanned_at_utc: t.utc
      });
      setMsg('');
    }
    saveRecords();
    renderList();
  }

  function renderList(){
    listEl.innerHTML = '';
    countEl.textContent = `저장 ${records.length}건`;
    records.slice().reverse().forEach(r=>{
      const li=document.createElement('li');
      li.innerHTML = `<span class="mono">${r.scanned_at_kst}</span> | id:${r.id} | name:${r.name} | loc:${r.loc} | owner:${r.owner}`;
      listEl.appendChild(li);
    });
  }

  function stop(){
    running=false;
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    video.style.display='none';
  }

  async function start(){
    if(location.protocol !== 'https:' && location.hostname !== 'localhost'){
      setMsg('실시간 스캔은 HTTPS 또는 localhost에서만 가능합니다.');
      return;
    }
    if(!navigator.mediaDevices?.getUserMedia){
      setMsg('이 브라우저는 카메라 API를 지원하지 않습니다.');
      return;
    }
    try{
      stream = await navigator.mediaDevices.getUserMedia({
        video:{ facingMode:{ideal:'environment'}, width:{ideal:1280}, height:{ideal:720} }
      });
      video.srcObject=stream; await video.play();
      video.style.display='block'; running=true; setMsg('QR을 화면에 담아주세요…');

      if('BarcodeDetector' in window){
        const detector = new BarcodeDetector({formats:['qr_code']});
        const useGrab = 'ImageCapture' in window;
        const track   = stream.getVideoTracks()[0];
        const grabber = useGrab ? new ImageCapture(track) : null;

        const loop = async ()=>{
          if(!running) return;
          try{
            let val=null;
            if(useGrab){
              const frame = await grabber.grabFrame();
              const found = await detector.detect(frame);
              val = found && found[0]?.rawValue;
            }else{
              const found = await detector.detect(video);
              val = found && found[0]?.rawValue;
            }
            if(val){
              stop();
              const parsed = parseQR(val);
              renderTable(parsed);
              upsertRecord(parsed);
              return;
            }
          }catch(e){
            jsqrFallback(); return;
          }
          requestAnimationFrame(loop);
        };
        loop();
      } else {
        jsqrFallback();
      }
    }catch(e){
      const map={NotAllowedError:'카메라 권한이 거부되었습니다. 브라우저/사이트 설정에서 허용해주세요.',
                 NotFoundError:'카메라 장치를 찾을 수 없습니다.',
                 NotReadableError:'다른 앱이 카메라 사용 중입니다.',
                 OverconstrainedError:'카메라 조건을 만족하지 못했습니다.',
                 SecurityError:'보안 정책으로 차단되었습니다.'};
      setMsg(map[e.name]||`카메라 오류: ${e.name||e}`);
    }
  }

  function jsqrFallback(){
    const c=document.createElement('canvas'), x=c.getContext('2d');
    let last=0;
    (function loop(){
      if(!running) return;
      const now=performance.now();
      if(now-last<120){ requestAnimationFrame(loop); return; }
      last=now;
      if(video.readyState===video.HAVE_ENOUGH_DATA){
        c.width=video.videoWidth||640; c.height=video.videoHeight||480;
        x.drawImage(video,0,0,c.width,c.height);
        const d=x.getImageData(0,0,c.width,c.height);
        const qr=jsQR(d.data,d.width,d.height,{inversionAttempts:'dontInvert'});
        if(qr && qr.data){
          stop();
          const parsed = parseQR(qr.data);
          renderTable(parsed);
          upsertRecord(parsed);
          return;
        }
      }
      requestAnimationFrame(loop);
    })();
  }

  // CSV 내보내기 (UTF-8 BOM으로 엑셀 한글 깨짐 방지)
  function exportCSV(){
    if(records.length===0){ setMsg('내보낼 데이터가 없습니다.'); return; }
    const header = ['scanned_at_kst','scanned_at_utc','id','name','loc','owner'];
    const rows = records.map(r=>[
      r.scanned_at_kst, r.scanned_at_utc, r.id, r.name, r.loc, r.owner
    ]);
    const esc = v => `"${String(v??'').replace(/"/g,'""')}"`;
    const lines = [header.map(esc).join(','), ...rows.map(row=>row.map(esc).join(','))].join('\r\n');
    const blob = new Blob(["\ufeff"+lines], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'qr_scans_' + new Date().toISOString().slice(0,10) + '.csv';
    a.click();
  }

  // 초기화(저장 데이터만 삭제)
  function clearAll(){
    if(!confirm('저장된 모든 레코드를 삭제할까요?')) return;
    records = []; saveRecords(); renderList();
  }

  // 이벤트
  document.getElementById('startBtn').onclick  = ()=>{ stop(); start(); };
  document.getElementById('exportBtn').onclick = exportCSV;
  document.getElementById('clearBtn').onclick  = clearAll;
})();
</script>
</body>
</html>
